<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin — editwitheli.com</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/favicon.png">
  <style>
    :root {
      --bg: #111;
      --surface: #1a1a1a;
      --surface-hover: #242424;
      --border: #333;
      --text: #eee;
      --text-dim: #888;
      --accent: #4a9eff;
      --accent-hover: #3a8eef;
      --danger: #e55;
      --success: #4c4;
      --radius: 8px;
      --font: 'Inter', -apple-system, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ---- Login ---- */
    .login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .login-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 40px;
      width: 100%;
      max-width: 360px;
      text-align: center;
    }
    .login-box h1 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 24px;
      color: var(--text-dim);
    }
    .login-box input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font);
      margin-bottom: 16px;
    }
    .login-box input:focus { outline: none; border-color: var(--accent); }
    .login-box button {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      font-family: var(--font);
    }
    .login-box button:hover { background: var(--accent-hover); }
    .login-error {
      color: var(--danger);
      font-size: 13px;
      margin-top: 12px;
      display: none;
    }

    /* ---- Dashboard ---- */
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .top-bar h1 { font-size: 16px; font-weight: 500; }
    .top-bar .actions { display: flex; gap: 10px; }
    .btn {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      font-size: 13px;
      font-family: var(--font);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s;
    }
    .btn:hover { background: var(--surface-hover); }
    .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-danger { border-color: var(--danger); color: var(--danger); }
    .btn-danger:hover { background: var(--danger); color: #fff; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ---- Project Grid ---- */
    .project-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 20px;
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
      padding-bottom: 100px;
    }
    .admin-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      cursor: grab;
      transition: transform 0.15s, box-shadow 0.15s;
      position: relative;
    }
    .admin-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .admin-card.dragging { opacity: 0.5; transform: scale(0.95); }
    .admin-card.drag-over { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent); }
    .admin-card .card-thumb {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      display: block;
      background: #000;
    }
    .admin-card .card-body { padding: 12px 14px; }
    .admin-card .card-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .admin-card .card-studio {
      font-size: 12px;
      color: var(--text-dim);
      font-style: italic;
    }
    .admin-card .card-role {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 2px;
    }
    .admin-card .card-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .admin-card:hover .card-actions { opacity: 1; }
    .card-actions button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.7);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .card-actions button:hover { background: rgba(0,0,0,0.9); }
    .card-actions .delete-btn:hover { background: var(--danger); }

    /* Add card */
    .add-card {
      background: var(--surface);
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      cursor: pointer;
      transition: border-color 0.15s;
      font-size: 14px;
      color: var(--text-dim);
    }
    .add-card:hover { border-color: var(--accent); color: var(--accent); }

    /* ---- Modal ---- */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 100%;
      max-width: 560px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 28px;
    }
    .modal h2 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-dim);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font);
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .video-url-group {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .video-url-group input { flex: 1; }
    .video-url-group button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-dim);
      cursor: pointer;
      flex-shrink: 0;
      font-size: 16px;
    }
    .video-url-group button:hover { border-color: var(--danger); color: var(--danger); }
    .add-video-btn {
      font-size: 13px;
      color: var(--accent);
      cursor: pointer;
      background: none;
      border: none;
      font-family: var(--font);
      padding: 4px 0;
    }
    .add-video-btn:hover { text-decoration: underline; }
    .thumb-preview {
      width: 120px;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 4px;
      background: #000;
      display: block;
      margin-bottom: 8px;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    /* ---- Publish Bar ---- */
    .publish-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 14px 24px;
      display: none;
      align-items: center;
      justify-content: space-between;
      z-index: 150;
    }
    .publish-bar.active { display: flex; }
    .publish-bar .change-count {
      font-size: 14px;
      color: var(--text-dim);
    }
    .publish-bar .change-count strong {
      color: var(--accent);
    }
    .publish-status {
      font-size: 13px;
      margin-left: 12px;
    }
    .publish-status.success { color: var(--success); }
    .publish-status.error { color: var(--danger); }

    /* ---- Toast ---- */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 12px 24px;
      border-radius: var(--radius);
      font-size: 14px;
      z-index: 300;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; }

    /* Drag ghost */
    .drag-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 999;
      opacity: 0.8;
      transform: rotate(3deg);
    }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>editwitheli.com admin</h1>
      <form id="loginForm">
        <input type="password" id="passwordInput" placeholder="Password" autocomplete="current-password">
        <button type="submit">Log In</button>
      </form>
      <div class="login-error" id="loginError">Invalid password. Try again.</div>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <div class="top-bar">
      <h1>Projects</h1>
      <div class="actions">
        <button class="btn" id="refreshBtn" title="Refresh from live site">Refresh</button>
        <button class="btn" id="logoutBtn">Log Out</button>
      </div>
    </div>

    <div class="project-grid" id="projectGrid"></div>

    <!-- Publish Bar -->
    <div class="publish-bar" id="publishBar">
      <div>
        <span class="change-count"><strong id="changeCount">0</strong> unsaved changes</span>
        <span class="publish-status" id="publishStatus"></span>
      </div>
      <div class="actions">
        <button class="btn" id="discardBtn">Discard</button>
        <button class="btn btn-primary" id="publishBtn">Publish</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h2 id="modalTitle">Edit Project</h2>
      <div class="form-group">
        <label>Title</label>
        <input type="text" id="editTitle" placeholder="Project title">
      </div>
      <div class="form-group">
        <label>Studio</label>
        <input type="text" id="editStudio" placeholder="Studio name (leave blank if none)">
      </div>
      <div class="form-group">
        <label>Role</label>
        <input type="text" id="editRole" placeholder="Your role">
      </div>
      <div class="form-group">
        <label>Slug (URL path)</label>
        <input type="text" id="editSlug" placeholder="project-slug">
      </div>
      <div class="form-group">
        <label>Video URLs</label>
        <div id="videoUrlList"></div>
        <button class="add-video-btn" id="addVideoBtn">+ Add another video</button>
      </div>
      <div class="form-group">
        <label>Page Type</label>
        <select id="editPageType">
          <option value="single">Single Video</option>
          <option value="stacked">Stacked Videos</option>
          <option value="documentary">Documentary</option>
        </select>
      </div>
      <div class="form-group">
        <label>Credits (HTML)</label>
        <textarea id="editCredit" placeholder="Editor."></textarea>
      </div>
      <div class="form-group" id="docDescGroup" style="display:none">
        <label>Documentary Description</label>
        <textarea id="editDocDesc" placeholder="Short description for documentary sidebar"></textarea>
      </div>
      <div class="form-group">
        <label>Thumbnail</label>
        <img class="thumb-preview" id="thumbPreview" src="" alt="Thumbnail">
        <input type="file" id="thumbUpload" accept="image/*">
      </div>
      <div class="modal-actions">
        <button class="btn" id="editCancel">Cancel</button>
        <button class="btn btn-primary" id="editSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

<script>
const API = '';  // same origin
let token = sessionStorage.getItem('admin_token') || '';
let projects = [];
let stagedFiles = [];
let deletedFiles = [];
let originalProjects = [];
let editingIndex = -1;
let newThumbFile = null;

// ---- Auth ----
const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');
const loginScreen = document.getElementById('loginScreen');
const dashboard = document.getElementById('dashboard');

loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  loginError.style.display = 'none';
  const password = document.getElementById('passwordInput').value;
  try {
    const r = await fetch(`${API}/api/auth`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password }),
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data.error);
    token = data.token;
    sessionStorage.setItem('admin_token', token);
    showDashboard();
  } catch (err) {
    loginError.textContent = err.message || 'Invalid password';
    loginError.style.display = 'block';
  }
});

document.getElementById('logoutBtn').addEventListener('click', () => {
  token = '';
  sessionStorage.removeItem('admin_token');
  loginScreen.style.display = 'flex';
  dashboard.classList.remove('active');
});

// Auto-login if token exists
if (token) {
  showDashboard();
} else {
  loginScreen.style.display = 'flex';
}

async function showDashboard() {
  loginScreen.style.display = 'none';
  dashboard.classList.add('active');
  await loadProjects();
}

// ---- Projects ----
async function apiCall(path, options = {}) {
  const r = await fetch(`${API}${path}`, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`,
      ...(options.headers || {}),
    },
  });
  if (r.status === 401) {
    token = '';
    sessionStorage.removeItem('admin_token');
    loginScreen.style.display = 'flex';
    dashboard.classList.remove('active');
    throw new Error('Session expired');
  }
  const data = await r.json();
  if (!r.ok) throw new Error(data.error);
  return data;
}

async function loadProjects() {
  try {
    const data = await apiCall('/api/projects');
    projects = data;
    originalProjects = JSON.parse(JSON.stringify(data));
    stagedFiles = [];
    deletedFiles = [];
    renderGrid();
    updatePublishBar();
  } catch (err) {
    showToast('Failed to load projects: ' + err.message);
  }
}

document.getElementById('refreshBtn').addEventListener('click', loadProjects);

function renderGrid() {
  const grid = document.getElementById('projectGrid');
  grid.innerHTML = '';

  projects.forEach((p, i) => {
    const card = document.createElement('div');
    card.className = 'admin-card';
    card.draggable = true;
    card.dataset.index = i;

    const thumbSrc = p.thumbnail.startsWith('http') ? p.thumbnail : `/${p.thumbnail}`;

    card.innerHTML = `
      <div class="card-actions">
        <button class="edit-btn" title="Edit" data-index="${i}">&#9998;</button>
        <button class="delete-btn" title="Delete" data-index="${i}">&times;</button>
      </div>
      <img class="card-thumb" src="${thumbSrc}" alt="${esc(p.title)}" onerror="this.style.background='#333'">
      <div class="card-body">
        <div class="card-title">${esc(p.title)}</div>
        ${p.studio ? `<div class="card-studio">for ${esc(p.studio)}</div>` : ''}
        <div class="card-role">${esc(p.role)}</div>
      </div>
    `;

    // Drag events
    card.addEventListener('dragstart', onDragStart);
    card.addEventListener('dragend', onDragEnd);
    card.addEventListener('dragover', onDragOver);
    card.addEventListener('drop', onDrop);
    card.addEventListener('dragenter', (e) => { e.preventDefault(); card.classList.add('drag-over'); });
    card.addEventListener('dragleave', () => card.classList.remove('drag-over'));

    // Edit/Delete clicks
    card.querySelector('.edit-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      openEditModal(i);
    });
    card.querySelector('.delete-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      deleteProject(i);
    });

    grid.appendChild(card);
  });

  // Add card
  const addCard = document.createElement('div');
  addCard.className = 'add-card';
  addCard.textContent = '+ Add Project';
  addCard.addEventListener('click', () => openEditModal(-1));
  grid.appendChild(addCard);
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// ---- Drag & Drop ----
let dragIndex = -1;

function onDragStart(e) {
  dragIndex = parseInt(e.currentTarget.dataset.index);
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function onDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  document.querySelectorAll('.admin-card').forEach(c => c.classList.remove('drag-over'));
}

function onDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

function onDrop(e) {
  e.preventDefault();
  const dropIndex = parseInt(e.currentTarget.dataset.index);
  e.currentTarget.classList.remove('drag-over');
  if (dragIndex === dropIndex) return;

  const moved = projects.splice(dragIndex, 1)[0];
  projects.splice(dropIndex, 0, moved);
  markChanged();
  renderGrid();
}

// ---- Edit Modal ----
function openEditModal(index) {
  editingIndex = index;
  newThumbFile = null;
  const modal = document.getElementById('editModal');
  const p = index >= 0 ? projects[index] : {
    title: '', studio: '', role: '', slug: '', videoUrls: [''], pageType: 'single', credit: '', description: ''
  };

  document.getElementById('modalTitle').textContent = index >= 0 ? 'Edit Project' : 'Add Project';
  document.getElementById('editTitle').value = p.title || '';
  document.getElementById('editStudio').value = p.studio || '';
  document.getElementById('editRole').value = p.role || '';
  document.getElementById('editSlug').value = p.slug || '';
  document.getElementById('editSlug').disabled = index >= 0;
  document.getElementById('editPageType').value = p.pageType || 'single';
  document.getElementById('editCredit').value = p.credit || '';
  document.getElementById('editDocDesc').value = p.description || '';
  document.getElementById('thumbUpload').value = '';

  const thumbSrc = p.thumbnail ? (p.thumbnail.startsWith('http') ? p.thumbnail : `/${p.thumbnail}`) : '';
  document.getElementById('thumbPreview').src = thumbSrc;

  // Show/hide doc description
  toggleDocDesc();

  // Video URLs
  renderVideoUrls(p.videoUrls || ['']);

  modal.classList.add('active');
}

document.getElementById('editPageType').addEventListener('change', toggleDocDesc);
function toggleDocDesc() {
  document.getElementById('docDescGroup').style.display =
    document.getElementById('editPageType').value === 'documentary' ? 'block' : 'none';
}

function renderVideoUrls(urls) {
  const container = document.getElementById('videoUrlList');
  container.innerHTML = '';
  urls.forEach((url, i) => {
    const div = document.createElement('div');
    div.className = 'video-url-group';
    div.innerHTML = `
      <input type="text" value="${esc(url)}" placeholder="https://www.youtube.com/embed/VIDEO_ID" data-vi="${i}">
      <button title="Remove" data-vi="${i}">&times;</button>
    `;
    div.querySelector('button').addEventListener('click', () => {
      const inputs = container.querySelectorAll('input');
      if (inputs.length <= 1) return;
      div.remove();
    });
    container.appendChild(div);
  });
}

document.getElementById('addVideoBtn').addEventListener('click', () => {
  const container = document.getElementById('videoUrlList');
  const div = document.createElement('div');
  div.className = 'video-url-group';
  div.innerHTML = `
    <input type="text" value="" placeholder="https://www.youtube.com/embed/VIDEO_ID">
    <button title="Remove">&times;</button>
  `;
  div.querySelector('button').addEventListener('click', () => {
    const inputs = container.querySelectorAll('input');
    if (inputs.length <= 1) return;
    div.remove();
  });
  container.appendChild(div);
});

document.getElementById('thumbUpload').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  newThumbFile = file;
  const reader = new FileReader();
  reader.onload = (ev) => {
    document.getElementById('thumbPreview').src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

document.getElementById('editCancel').addEventListener('click', () => {
  document.getElementById('editModal').classList.remove('active');
});

document.getElementById('editSave').addEventListener('click', async () => {
  const title = document.getElementById('editTitle').value.trim();
  const studio = document.getElementById('editStudio').value.trim();
  const role = document.getElementById('editRole').value.trim();
  const slug = document.getElementById('editSlug').value.trim().replace(/\s+/g, '-').toLowerCase();
  const pageType = document.getElementById('editPageType').value;
  const credit = document.getElementById('editCredit').value.trim();
  const description = document.getElementById('editDocDesc').value.trim();

  if (!title || !slug) {
    showToast('Title and slug are required');
    return;
  }

  // Collect video URLs
  const videoInputs = document.querySelectorAll('#videoUrlList input');
  const videoUrls = Array.from(videoInputs).map(i => i.value.trim()).filter(Boolean);

  // Handle thumbnail upload
  let thumbnail;
  if (newThumbFile) {
    try {
      const base64 = await fileToBase64(newThumbFile);
      const uploadResult = await apiCall('/api/upload', {
        method: 'POST',
        body: JSON.stringify({
          filename: `${slug}.webp`,
          data: base64,
        }),
      });
      stagedFiles.push(uploadResult.stagedFile);
      thumbnail = uploadResult.stagedFile.path;
    } catch (err) {
      showToast('Failed to process image: ' + err.message);
      return;
    }
  }

  if (editingIndex >= 0) {
    // Update existing
    const p = projects[editingIndex];
    p.title = title;
    p.studio = studio;
    p.role = role;
    p.pageType = pageType;
    p.credit = credit;
    p.description = description;
    p.videoUrls = videoUrls;
    if (thumbnail) p.thumbnail = thumbnail;
  } else {
    // Add new
    projects.push({
      slug,
      title,
      studio,
      role,
      pageType,
      credit: credit || role + '.',
      description,
      videoUrls,
      posters: [],
      thumbnail: thumbnail || `images/${slug}.webp`,
      hasLaurels: false,
    });
  }

  markChanged();
  renderGrid();
  document.getElementById('editModal').classList.remove('active');
  showToast(editingIndex >= 0 ? 'Project updated' : 'Project added');
});

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Close modal on overlay click
document.getElementById('editModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) {
    e.currentTarget.classList.remove('active');
  }
});

// ---- Delete ----
function deleteProject(index) {
  const p = projects[index];
  if (!confirm(`Delete "${p.title}"? This will remove it on next publish.`)) return;
  deletedFiles.push(`projects/${p.slug}.html`);
  projects.splice(index, 1);
  markChanged();
  renderGrid();
  showToast('Project marked for deletion');
}

// ---- Changes tracking ----
let changeCount = 0;

function markChanged() {
  changeCount++;
  updatePublishBar();
}

function updatePublishBar() {
  const bar = document.getElementById('publishBar');
  const hasChanges = changeCount > 0 || stagedFiles.length > 0;
  bar.classList.toggle('active', hasChanges);
  document.getElementById('changeCount').textContent = changeCount + stagedFiles.length;
  document.getElementById('publishStatus').textContent = '';
}

document.getElementById('discardBtn').addEventListener('click', () => {
  if (!confirm('Discard all changes?')) return;
  projects = JSON.parse(JSON.stringify(originalProjects));
  stagedFiles = [];
  deletedFiles = [];
  changeCount = 0;
  renderGrid();
  updatePublishBar();
  showToast('Changes discarded');
});

// ---- Publish ----
document.getElementById('publishBtn').addEventListener('click', async () => {
  const btn = document.getElementById('publishBtn');
  const status = document.getElementById('publishStatus');
  btn.disabled = true;
  status.textContent = 'Publishing...';
  status.className = 'publish-status';

  try {
    // 1. Generate updated HTML via API
    const result = await apiCall('/api/projects', {
      method: 'PUT',
      body: JSON.stringify({ projects }),
    });

    // Combine all staged files
    const allFiles = [...(result.stagedFiles || []), ...stagedFiles];

    // 2. Also regenerate individual project pages that were edited
    for (const p of projects) {
      if (p._edited || editingIndex >= 0) {
        const pageResult = await apiCall('/api/projects', {
          method: 'POST',
          body: JSON.stringify(p),
        });
        // Get the project page file from staged files
        const projectPageFile = (pageResult.stagedFiles || []).find(f => f.path.startsWith('projects/'));
        if (projectPageFile) {
          // Replace if already exists, otherwise add
          const existingIdx = allFiles.findIndex(f => f.path === projectPageFile.path);
          if (existingIdx >= 0) allFiles[existingIdx] = projectPageFile;
          else allFiles.push(projectPageFile);
        }
      }
    }

    // 3. Publish to GitHub
    const publishResult = await apiCall('/api/publish', {
      method: 'POST',
      body: JSON.stringify({
        files: allFiles,
        deletedFiles,
        message: `Update from admin panel — ${new Date().toLocaleString()}`,
      }),
    });

    status.textContent = 'Published! Deploying...';
    status.className = 'publish-status success';

    // Reset state
    originalProjects = JSON.parse(JSON.stringify(projects));
    stagedFiles = [];
    deletedFiles = [];
    changeCount = 0;

    setTimeout(() => {
      updatePublishBar();
      showToast('Changes published — site will update in ~30 seconds');
    }, 2000);

  } catch (err) {
    status.textContent = 'Error: ' + err.message;
    status.className = 'publish-status error';
  } finally {
    btn.disabled = false;
  }
});

// ---- Toast ----
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// ---- Keyboard shortcuts ----
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.getElementById('editModal').classList.remove('active');
  }
});
</script>
</body>
</html>
