<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin — editwitheli.com</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/favicon.png">
  <style>
    :root {
      --bg: #111;
      --surface: #1a1a1a;
      --surface-hover: #242424;
      --border: #333;
      --text: #eee;
      --text-dim: #888;
      --accent: #4a9eff;
      --accent-hover: #3a8eef;
      --danger: #e55;
      --success: #4c4;
      --radius: 8px;
      --font: 'Inter', -apple-system, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ---- Login ---- */
    .login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .login-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 40px;
      width: 100%;
      max-width: 360px;
      text-align: center;
    }
    .login-box h1 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 24px;
      color: var(--text-dim);
    }
    .login-box input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font);
      margin-bottom: 16px;
    }
    .login-box input:focus { outline: none; border-color: var(--accent); }
    .login-box button {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      font-family: var(--font);
    }
    .login-box button:hover { background: var(--accent-hover); }
    .login-error {
      color: var(--danger);
      font-size: 13px;
      margin-top: 12px;
      display: none;
    }

    /* ---- Dashboard ---- */
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .top-bar h1 { font-size: 16px; font-weight: 500; }
    .top-bar .actions { display: flex; gap: 10px; }
    .btn {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      font-size: 13px;
      font-family: var(--font);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s;
    }
    .btn:hover { background: var(--surface-hover); }
    .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-danger { border-color: var(--danger); color: var(--danger); }
    .btn-danger:hover { background: var(--danger); color: #fff; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ---- Project Grid ---- */
    .project-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 20px;
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
      padding-bottom: 100px;
    }
    .admin-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      cursor: grab;
      transition: transform 0.15s, box-shadow 0.15s;
      position: relative;
    }
    .admin-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .admin-card.dragging { opacity: 0.5; transform: scale(0.95); }
    .admin-card.drag-over { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent); }
    .admin-card .card-thumb {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      display: block;
      background: #000;
    }
    .admin-card .card-thumb-wrap {
      position: relative;
      cursor: pointer;
    }
    .admin-card .card-thumb-wrap::after {
      content: 'Double-click to edit page';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 6px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 11px;
      text-align: center;
      opacity: 0;
      transition: opacity 0.15s;
      pointer-events: none;
    }
    .admin-card .card-thumb-wrap:hover::after { opacity: 1; }
    .admin-card .card-body { padding: 12px 14px; }
    .admin-card .card-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 2px;
      outline: none;
      border-radius: 3px;
      transition: background 0.15s;
    }
    .admin-card .card-title:hover { background: var(--surface-hover); }
    .admin-card .card-title:focus { background: var(--bg); box-shadow: 0 0 0 1px var(--accent); }
    .admin-card .card-studio {
      font-size: 12px;
      color: var(--text-dim);
      font-style: italic;
      outline: none;
      border-radius: 3px;
      transition: background 0.15s;
    }
    .admin-card .card-studio:hover { background: var(--surface-hover); }
    .admin-card .card-studio:focus { background: var(--bg); box-shadow: 0 0 0 1px var(--accent); }
    .admin-card .card-role {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 2px;
      outline: none;
      border-radius: 3px;
      transition: background 0.15s;
    }
    .admin-card .card-role:hover { background: var(--surface-hover); }
    .admin-card .card-role:focus { background: var(--bg); box-shadow: 0 0 0 1px var(--accent); }
    .admin-card [contenteditable]:empty::before {
      content: attr(data-placeholder);
      color: var(--text-dim);
      opacity: 0.5;
    }
    .admin-card .card-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .admin-card:hover .card-actions { opacity: 1; }
    .card-actions button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.7);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .card-actions button:hover { background: rgba(0,0,0,0.9); }
    .card-actions .delete-btn:hover { background: var(--danger); }

    /* Add card */
    .add-card {
      background: var(--surface);
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      cursor: pointer;
      transition: border-color 0.15s;
      font-size: 14px;
      color: var(--text-dim);
    }
    .add-card:hover { border-color: var(--accent); color: var(--accent); }

    /* ---- Modal ---- */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 100%;
      max-width: 560px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 28px;
    }
    .modal h2 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-dim);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font);
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .video-url-group {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .video-url-group input { flex: 1; }
    .video-url-group button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-dim);
      cursor: pointer;
      flex-shrink: 0;
      font-size: 16px;
    }
    .video-url-group button:hover { border-color: var(--danger); color: var(--danger); }
    .add-video-btn {
      font-size: 13px;
      color: var(--accent);
      cursor: pointer;
      background: none;
      border: none;
      font-family: var(--font);
      padding: 4px 0;
    }
    .add-video-btn:hover { text-decoration: underline; }
    .thumb-preview {
      width: 120px;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 4px;
      background: #000;
      display: block;
      margin-bottom: 8px;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    /* ---- Publish Bar ---- */
    .publish-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 14px 24px;
      display: none;
      align-items: center;
      justify-content: space-between;
      z-index: 150;
    }
    .publish-bar.active { display: flex; }
    .publish-bar .change-count {
      font-size: 14px;
      color: var(--text-dim);
    }
    .publish-bar .change-count strong {
      color: var(--accent);
    }
    .publish-status {
      font-size: 13px;
      margin-left: 12px;
    }
    .publish-status.success { color: var(--success); }
    .publish-status.error { color: var(--danger); }

    /* ---- Toast ---- */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 12px 24px;
      border-radius: var(--radius);
      font-size: 14px;
      z-index: 300;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; }

    /* Drag ghost */
    .drag-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 999;
      opacity: 0.8;
      transform: rotate(3deg);
    }

    /* ---- Project Editor ---- */
    .project-editor { display: none; }
    .project-editor.active { display: block; }
    .editor-top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .editor-top-bar h1 {
      font-size: 16px;
      font-weight: 500;
      flex: 1;
      margin: 0 20px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .editor-body {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
      padding-bottom: 120px;
    }
    .editor-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }
    .editor-section h3 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .editor-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 12px;
    }
    .editor-field label {
      display: block;
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 6px;
      font-weight: 500;
    }
    .editor-field input,
    .editor-field select,
    .editor-section > textarea {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font);
    }
    .editor-field input:focus,
    .editor-field select:focus,
    .editor-section > textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .editor-section > textarea {
      resize: vertical;
      min-height: 100px;
    }
    .video-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 8px;
      transition: border-color 0.15s;
    }
    .video-item.dragging { opacity: 0.5; }
    .video-item.drag-over { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
    .video-item .drag-handle {
      color: var(--text-dim);
      cursor: grab;
      font-size: 16px;
      user-select: none;
      flex-shrink: 0;
      letter-spacing: -2px;
    }
    .video-item .video-poster-preview {
      width: 100px;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 4px;
      background: #333;
      flex-shrink: 0;
      display: block;
    }
    .video-item .video-fields {
      flex: 1;
      min-width: 0;
    }
    .video-item .video-fields input[type="text"] {
      width: 100%;
      padding: 8px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 13px;
      font-family: var(--font);
      margin-bottom: 6px;
    }
    .video-item .video-fields input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
    }
    .video-item .video-fields input[type="file"] {
      font-size: 12px;
      color: var(--text-dim);
    }
    .video-item .video-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex-shrink: 0;
    }
    .video-item .video-actions button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-dim);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .video-item .video-actions button:hover {
      border-color: var(--danger);
      color: var(--danger);
    }
    .editor-add-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: none;
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      color: var(--text-dim);
      font-size: 13px;
      cursor: pointer;
      font-family: var(--font);
      margin-top: 8px;
    }
    .editor-add-btn:hover { border-color: var(--accent); color: var(--accent); }
    .doc-fields { display: none; margin-top: 16px; }
    .doc-fields.active { display: block; }
    /* Scrub frame previews */
    .frame-preview {
      width: 100px;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 4px;
      background: #333;
      display: block;
      position: relative;
    }
    .frame-preview .frame-num {
      position: absolute;
      top: 3px;
      left: 5px;
      font-size: 10px;
      color: #fff;
      background: rgba(0,0,0,0.6);
      padding: 1px 5px;
      border-radius: 3px;
    }
    .frame-preview .frame-remove {
      position: absolute;
      top: 3px;
      right: 3px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .frame-preview:hover .frame-remove { opacity: 1; }
    .frame-preview .frame-remove:hover { background: var(--danger); }
    /* Rich text editor */
    .rte-toolbar {
      display: flex;
      gap: 4px;
      padding: 6px 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: var(--radius) var(--radius) 0 0;
    }
    .rte-toolbar button {
      padding: 4px 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-dim);
      cursor: pointer;
      font-family: var(--font);
      font-size: 13px;
      line-height: 1.4;
    }
    .rte-toolbar button:hover { background: var(--surface-hover); color: var(--text); }
    .rte-toolbar button.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .rte-editor {
      min-height: 100px;
      padding: 12px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 0 0 var(--radius) var(--radius);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font);
      outline: none;
      line-height: 1.6;
    }
    .rte-editor:focus { border-color: var(--accent); }
    .rte-editor strong, .rte-editor b { font-weight: 600; }
    .rte-editor em, .rte-editor i { font-style: italic; }
    .rte-editor:empty::before {
      content: 'Editor.';
      color: var(--text-dim);
      opacity: 0.5;
    }
    @media (max-width: 600px) {
      .editor-row { grid-template-columns: 1fr; }
      .video-item { flex-wrap: wrap; }
      .video-item .video-poster-preview { width: 80px; }
    }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>editwitheli.com admin</h1>
      <form id="loginForm">
        <input type="password" id="passwordInput" placeholder="Password" autocomplete="current-password">
        <button type="submit">Log In</button>
      </form>
      <div class="login-error" id="loginError">Invalid password. Try again.</div>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <div class="top-bar">
      <h1>Projects</h1>
      <div class="actions">
        <button class="btn" id="refreshBtn" title="Refresh from live site">Refresh</button>
        <button class="btn" id="logoutBtn">Log Out</button>
      </div>
    </div>

    <div class="project-grid" id="projectGrid"></div>

    <!-- Publish Bar -->
    <div class="publish-bar" id="publishBar">
      <div>
        <span class="change-count"><strong id="changeCount">0</strong> unsaved changes</span>
        <span class="publish-status" id="publishStatus"></span>
      </div>
      <div class="actions">
        <button class="btn" id="discardBtn">Discard</button>
        <button class="btn btn-primary" id="publishBtn">Publish</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h2 id="modalTitle">Edit Project</h2>
      <div class="form-group">
        <label>Title</label>
        <input type="text" id="editTitle" placeholder="Project title">
      </div>
      <div class="form-group">
        <label>Studio</label>
        <input type="text" id="editStudio" placeholder="Studio name (leave blank if none)">
      </div>
      <div class="form-group">
        <label>Role</label>
        <input type="text" id="editRole" placeholder="Your role">
      </div>
      <div class="form-group">
        <label>Slug (URL path)</label>
        <input type="text" id="editSlug" placeholder="project-slug">
      </div>
      <div class="form-group">
        <label>Video URLs</label>
        <div id="videoUrlList"></div>
        <button class="add-video-btn" id="addVideoBtn">+ Add another video</button>
      </div>
      <div class="form-group">
        <label>Page Type</label>
        <select id="editPageType">
          <option value="single">Single Video</option>
          <option value="stacked">Stacked Videos</option>
          <option value="documentary">Documentary</option>
        </select>
      </div>
      <div class="form-group">
        <label>Credits (HTML)</label>
        <textarea id="editCredit" placeholder="Editor."></textarea>
      </div>
      <div class="form-group" id="docDescGroup" style="display:none">
        <label>Documentary Description</label>
        <textarea id="editDocDesc" placeholder="Short description for documentary sidebar"></textarea>
      </div>
      <div class="form-group">
        <label>Thumbnail</label>
        <img class="thumb-preview" id="thumbPreview" src="" alt="Thumbnail">
        <input type="file" id="thumbUpload" accept="image/*">
      </div>
      <div class="modal-actions">
        <button class="btn" id="editCancel">Cancel</button>
        <button class="btn btn-primary" id="editSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Project Editor -->
  <div class="project-editor" id="projectEditor">
    <div class="editor-top-bar">
      <button class="btn" id="editorBackBtn">&larr; Back</button>
      <h1 id="editorProjectTitle">Edit Project</h1>
      <button class="btn btn-primary" id="editorSaveBtn">Save</button>
    </div>
    <div class="editor-body">
      <!-- Project Info -->
      <div class="editor-section">
        <h3>Project Info</h3>
        <div class="editor-row">
          <div class="editor-field">
            <label>Title</label>
            <input type="text" id="editorProjTitle" placeholder="Project title">
          </div>
          <div class="editor-field">
            <label>Studio</label>
            <input type="text" id="editorProjStudio" placeholder="Studio name (optional)">
          </div>
        </div>
        <div class="editor-row">
          <div class="editor-field">
            <label>Role</label>
            <input type="text" id="editorProjRole" placeholder="Editor">
          </div>
        </div>
      </div>
      <!-- Homepage Thumbnail -->
      <div class="editor-section">
        <h3>Homepage Thumbnail</h3>
        <p style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">The image shown on the main grid. Separate from the video poster screenshots below.</p>
        <img id="editorThumbPreview" style="width:200px;aspect-ratio:16/9;object-fit:cover;border-radius:4px;background:#333;display:block;margin-bottom:10px;" src="" alt="">
        <input type="file" id="editorThumbUpload" accept="image/*">
      </div>
      <!-- Scrub Frames -->
      <div class="editor-section">
        <h3>Hover Scrub Frames</h3>
        <p style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">Upload 4–10 still frames from your video. Visitors scrub through them by moving their cursor across the thumbnail on the homepage.</p>
        <div id="editorFrameList" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;"></div>
        <div style="display:flex;gap:10px;align-items:center;">
          <input type="file" id="editorFrameUpload" accept="image/*" multiple>
          <button class="btn btn-danger" id="editorClearFrames" style="font-size:12px;padding:6px 12px;">Clear All</button>
        </div>
      </div>

      <!-- Videos -->
      <div class="editor-section">
        <h3>Videos</h3>
        <p style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">Each video has its own poster image (the still shown before pressing play). Drag to reorder.</p>
        <div id="editorVideoList"></div>
        <button class="editor-add-btn" id="editorAddVideoBtn">+ Add Video</button>
      </div>
      <!-- Credits -->
      <div class="editor-section">
        <h3>Credits</h3>
        <div class="rte-toolbar" id="rteToolbar">
          <button type="button" data-cmd="bold" title="Bold"><b>B</b></button>
          <button type="button" data-cmd="italic" title="Italic"><i>I</i></button>
          <button type="button" data-cmd="insertUnorderedList" title="Bullet list">&#8226; List</button>
          <button type="button" data-cmd="removeFormat" title="Clear formatting">Clear</button>
        </div>
        <div class="rte-editor" id="editorCredits" contenteditable="true"></div>
      </div>
      <!-- Page Settings -->
      <div class="editor-section">
        <h3>Page Settings</h3>
        <div class="editor-row">
          <div class="editor-field">
            <label>Page Type</label>
            <select id="editorPageType">
              <option value="single">Single Video</option>
              <option value="stacked">Stacked Videos</option>
              <option value="grid">Video Grid (2-up with captions)</option>
              <option value="documentary">Documentary</option>
            </select>
          </div>
        </div>
        <div class="doc-fields" id="editorDocFields">
          <div class="editor-field" style="margin-bottom: 12px;">
            <label>Documentary Description</label>
            <textarea id="editorDocDesc" style="width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:14px;font-family:var(--font);resize:vertical;min-height:60px;" placeholder="Short description..."></textarea>
          </div>
          <div class="editor-field">
            <label>Documentary Poster Image</label>
            <input type="file" id="editorDocPosterUpload" accept="image/*">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

<script>
const API = '';  // same origin
let token = sessionStorage.getItem('admin_token') || '';
let projects = [];
let stagedFiles = [];
let deletedFiles = [];
let originalProjects = [];
let editingIndex = -1;
let newThumbFile = null;

// ---- Auth ----
const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');
const loginScreen = document.getElementById('loginScreen');
const dashboard = document.getElementById('dashboard');

loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  loginError.style.display = 'none';
  const password = document.getElementById('passwordInput').value;
  try {
    const r = await fetch(`${API}/api/auth`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password }),
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data.error);
    token = data.token;
    sessionStorage.setItem('admin_token', token);
    showDashboard();
  } catch (err) {
    loginError.textContent = err.message || 'Invalid password';
    loginError.style.display = 'block';
  }
});

document.getElementById('logoutBtn').addEventListener('click', () => {
  token = '';
  sessionStorage.removeItem('admin_token');
  loginScreen.style.display = 'flex';
  dashboard.classList.remove('active');
});

// Auto-login if token exists
if (token) {
  showDashboard();
} else {
  loginScreen.style.display = 'flex';
}

async function showDashboard() {
  loginScreen.style.display = 'none';
  dashboard.classList.add('active');
  await loadProjects();
}

// ---- Projects ----
async function apiCall(path, options = {}) {
  const r = await fetch(`${API}${path}`, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`,
      ...(options.headers || {}),
    },
  });
  if (r.status === 401) {
    token = '';
    sessionStorage.removeItem('admin_token');
    loginScreen.style.display = 'flex';
    dashboard.classList.remove('active');
    throw new Error('Session expired');
  }
  let data;
  const text = await r.text();
  try {
    data = JSON.parse(text);
  } catch (_) {
    throw new Error(`Server returned ${r.status}: ${text.slice(0, 200)}`);
  }
  if (!r.ok) {
    const msg = typeof data.error === 'string' ? data.error
      : data.error && data.error.message ? data.error.message
      : `Request failed (${r.status})`;
    throw new Error(msg);
  }
  return data;
}

async function loadProjects() {
  try {
    const data = await apiCall('/api/projects');
    projects = data;
    originalProjects = JSON.parse(JSON.stringify(data));
    stagedFiles = [];
    deletedFiles = [];
    renderGrid();
    updatePublishBar();
  } catch (err) {
    showToast('Failed to load projects: ' + err.message);
  }
}

document.getElementById('refreshBtn').addEventListener('click', loadProjects);

function renderGrid() {
  const grid = document.getElementById('projectGrid');
  grid.innerHTML = '';

  projects.forEach((p, i) => {
    const card = document.createElement('div');
    card.className = 'admin-card';
    card.draggable = true;
    card.dataset.index = i;

    const thumbSrc = p.thumbnail.startsWith('http') ? p.thumbnail : `/${p.thumbnail}`;

    card.innerHTML = `
      <div class="card-actions">
        <button class="edit-btn" title="Edit page" data-index="${i}">&#9998;</button>
        <button class="delete-btn" title="Delete" data-index="${i}">&times;</button>
      </div>
      <div class="card-thumb-wrap">
        <img class="card-thumb" src="${thumbSrc}" alt="${esc(p.title)}" onerror="this.style.background='#333'">
      </div>
      <div class="card-body">
        <div class="card-title" contenteditable="true" data-field="title" data-index="${i}" data-placeholder="Title">${esc(p.title)}</div>
        <div class="card-studio" contenteditable="true" data-field="studio" data-index="${i}" data-placeholder="Studio">${p.studio ? 'for ' + esc(p.studio) : ''}</div>
        <div class="card-role" contenteditable="true" data-field="role" data-index="${i}" data-placeholder="Role">${esc(p.role)}</div>
      </div>
    `;

    // Drag events
    card.addEventListener('dragstart', onDragStart);
    card.addEventListener('dragend', onDragEnd);
    card.addEventListener('dragover', onDragOver);
    card.addEventListener('drop', onDrop);
    card.addEventListener('dragenter', (e) => { e.preventDefault(); card.classList.add('drag-over'); });
    card.addEventListener('dragleave', () => card.classList.remove('drag-over'));

    // Double-click thumbnail to open editor
    card.querySelector('.card-thumb-wrap').addEventListener('dblclick', (e) => {
      e.stopPropagation();
      openProjectEditor(i);
    });

    // Edit/Delete clicks
    card.querySelector('.edit-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      openProjectEditor(i);
    });
    card.querySelector('.delete-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      deleteProject(i);
    });

    // Inline caption editing
    card.querySelectorAll('[contenteditable]').forEach(el => {
      // Prevent drag when editing text
      el.addEventListener('mousedown', (e) => { card.draggable = false; });
      el.addEventListener('blur', (e) => {
        card.draggable = true;
        const field = el.dataset.field;
        const idx = parseInt(el.dataset.index);
        const p = projects[idx];
        let val = el.textContent.trim();
        if (field === 'studio') {
          val = val.replace(/^for\s*/i, '');
        }
        if (p[field] !== val) {
          p[field] = val;
          p._edited = true;
          markChanged();
        }
      });
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); el.blur(); }
        if (e.key === 'Escape') { el.blur(); }
      });
    });

    grid.appendChild(card);
  });

  // Add card
  const addCard = document.createElement('div');
  addCard.className = 'add-card';
  addCard.textContent = '+ Add Project';
  addCard.addEventListener('click', () => openEditModal(-1));
  grid.appendChild(addCard);
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// ---- Drag & Drop ----
let dragIndex = -1;

function onDragStart(e) {
  dragIndex = parseInt(e.currentTarget.dataset.index);
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function onDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  document.querySelectorAll('.admin-card').forEach(c => c.classList.remove('drag-over'));
}

function onDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

function onDrop(e) {
  e.preventDefault();
  const dropIndex = parseInt(e.currentTarget.dataset.index);
  e.currentTarget.classList.remove('drag-over');
  if (dragIndex === dropIndex) return;

  const moved = projects.splice(dragIndex, 1)[0];
  projects.splice(dropIndex, 0, moved);
  markChanged();
  renderGrid();
}

// ---- Edit Modal ----
function openEditModal(index) {
  editingIndex = index;
  newThumbFile = null;
  const modal = document.getElementById('editModal');
  const p = index >= 0 ? projects[index] : {
    title: '', studio: '', role: '', slug: '', videoUrls: [''], pageType: 'single', credit: '', description: ''
  };

  document.getElementById('modalTitle').textContent = index >= 0 ? 'Edit Project' : 'Add Project';
  document.getElementById('editTitle').value = p.title || '';
  document.getElementById('editStudio').value = p.studio || '';
  document.getElementById('editRole').value = p.role || '';
  document.getElementById('editSlug').value = p.slug || '';
  document.getElementById('editSlug').disabled = index >= 0;
  document.getElementById('editPageType').value = p.pageType || 'single';
  document.getElementById('editCredit').value = p.credit || '';
  document.getElementById('editDocDesc').value = p.description || '';
  document.getElementById('thumbUpload').value = '';

  const thumbSrc = p.thumbnail ? (p.thumbnail.startsWith('http') ? p.thumbnail : `/${p.thumbnail}`) : '';
  document.getElementById('thumbPreview').src = thumbSrc;

  // Show/hide doc description
  toggleDocDesc();

  // Video URLs
  renderVideoUrls(p.videoUrls || ['']);

  modal.classList.add('active');
}

document.getElementById('editPageType').addEventListener('change', toggleDocDesc);
function toggleDocDesc() {
  document.getElementById('docDescGroup').style.display =
    document.getElementById('editPageType').value === 'documentary' ? 'block' : 'none';
}

function renderVideoUrls(urls) {
  const container = document.getElementById('videoUrlList');
  container.innerHTML = '';
  urls.forEach((url, i) => {
    const div = document.createElement('div');
    div.className = 'video-url-group';
    div.innerHTML = `
      <input type="text" value="${esc(url)}" placeholder="https://www.youtube.com/embed/VIDEO_ID" data-vi="${i}">
      <button title="Remove" data-vi="${i}">&times;</button>
    `;
    div.querySelector('button').addEventListener('click', () => {
      const inputs = container.querySelectorAll('input');
      if (inputs.length <= 1) return;
      div.remove();
    });
    container.appendChild(div);
  });
}

document.getElementById('addVideoBtn').addEventListener('click', () => {
  const container = document.getElementById('videoUrlList');
  const div = document.createElement('div');
  div.className = 'video-url-group';
  div.innerHTML = `
    <input type="text" value="" placeholder="https://www.youtube.com/embed/VIDEO_ID">
    <button title="Remove">&times;</button>
  `;
  div.querySelector('button').addEventListener('click', () => {
    const inputs = container.querySelectorAll('input');
    if (inputs.length <= 1) return;
    div.remove();
  });
  container.appendChild(div);
});

document.getElementById('thumbUpload').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  newThumbFile = file;
  const reader = new FileReader();
  reader.onload = (ev) => {
    document.getElementById('thumbPreview').src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

document.getElementById('editCancel').addEventListener('click', () => {
  document.getElementById('editModal').classList.remove('active');
});

document.getElementById('editSave').addEventListener('click', async () => {
  const title = document.getElementById('editTitle').value.trim();
  const studio = document.getElementById('editStudio').value.trim();
  const role = document.getElementById('editRole').value.trim();
  const slug = document.getElementById('editSlug').value.trim().replace(/\s+/g, '-').toLowerCase();
  const pageType = document.getElementById('editPageType').value;
  const credit = document.getElementById('editCredit').value.trim();
  const description = document.getElementById('editDocDesc').value.trim();

  if (!title || !slug) {
    showToast('Title and slug are required');
    return;
  }

  // Collect video URLs
  const videoInputs = document.querySelectorAll('#videoUrlList input');
  const videoUrls = Array.from(videoInputs).map(i => i.value.trim()).filter(Boolean);

  // Handle thumbnail upload
  let thumbnail;
  if (newThumbFile) {
    try {
      const base64 = await compressImage(newThumbFile);
      const uploadResult = await apiCall('/api/upload', {
        method: 'POST',
        body: JSON.stringify({
          filename: `${slug}.webp`,
          data: base64,
        }),
      });
      stagedFiles.push(uploadResult.stagedFile);
      thumbnail = uploadResult.stagedFile.path;
    } catch (err) {
      showToast('Failed to process image: ' + err.message);
      return;
    }
  }

  if (editingIndex >= 0) {
    // Update existing
    const p = projects[editingIndex];
    p.title = title;
    p.studio = studio;
    p.role = role;
    p.pageType = pageType;
    p.credit = credit;
    p.description = description;
    p.videoUrls = videoUrls;
    if (thumbnail) p.thumbnail = thumbnail;
  } else {
    // Add new
    projects.push({
      slug,
      title,
      studio,
      role,
      pageType,
      credit: credit || role + '.',
      description,
      videoUrls,
      posters: [],
      thumbnail: thumbnail || `images/${slug}.webp`,
      hasLaurels: false,
    });
  }

  markChanged();
  renderGrid();
  document.getElementById('editModal').classList.remove('active');
  showToast(editingIndex >= 0 ? 'Project updated' : 'Project added');
});

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Compress image client-side before uploading (avoids Vercel 4.5MB payload limit)
function compressImage(file, maxWidth = 1920, quality = 0.85) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      URL.revokeObjectURL(url);
      let w = img.naturalWidth;
      let h = img.naturalHeight;
      if (w > maxWidth) {
        h = Math.round(h * (maxWidth / w));
        w = maxWidth;
      }
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      // Try WebP first, fall back to JPEG
      let dataUrl = canvas.toDataURL('image/webp', quality);
      if (dataUrl.startsWith('data:image/webp')) {
        resolve(dataUrl.split(',')[1]);
      } else {
        dataUrl = canvas.toDataURL('image/jpeg', quality);
        resolve(dataUrl.split(',')[1]);
      }
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      reject(new Error('Failed to load image for compression'));
    };
    img.src = url;
  });
}

// Close modal on overlay click
document.getElementById('editModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) {
    e.currentTarget.classList.remove('active');
  }
});

// ---- Delete ----
function deleteProject(index) {
  const p = projects[index];
  if (!confirm(`Delete "${p.title}"? This will remove it on next publish.`)) return;
  deletedFiles.push(`projects/${p.slug}.html`);
  projects.splice(index, 1);
  markChanged();
  renderGrid();
  showToast('Project marked for deletion');
}

// ---- Changes tracking ----
let changeCount = 0;

function markChanged() {
  changeCount++;
  updatePublishBar();
}

function updatePublishBar() {
  const bar = document.getElementById('publishBar');
  const hasChanges = changeCount > 0 || stagedFiles.length > 0;
  bar.classList.toggle('active', hasChanges);
  document.getElementById('changeCount').textContent = changeCount + stagedFiles.length;
  document.getElementById('publishStatus').textContent = '';
}

document.getElementById('discardBtn').addEventListener('click', () => {
  if (!confirm('Discard all changes?')) return;
  projects = JSON.parse(JSON.stringify(originalProjects));
  stagedFiles = [];
  deletedFiles = [];
  changeCount = 0;
  renderGrid();
  updatePublishBar();
  showToast('Changes discarded');
});

// ---- Publish ----
document.getElementById('publishBtn').addEventListener('click', async () => {
  const btn = document.getElementById('publishBtn');
  const status = document.getElementById('publishStatus');
  btn.disabled = true;
  status.textContent = 'Publishing...';
  status.className = 'publish-status';

  try {
    // 1. Generate updated HTML via API
    const result = await apiCall('/api/projects', {
      method: 'PUT',
      body: JSON.stringify({ projects }),
    });

    // Combine all staged files
    const allFiles = [...(result.stagedFiles || []), ...stagedFiles];

    // 2. Regenerate project pages for edited projects
    for (const p of projects) {
      if (p._edited) {
        const pageResult = await apiCall('/api/projects', {
          method: 'PATCH',
          body: JSON.stringify(p),
        });
        const pageFiles = pageResult.stagedFiles || [];
        for (const pf of pageFiles) {
          const existingIdx = allFiles.findIndex(f => f.path === pf.path);
          if (existingIdx >= 0) allFiles[existingIdx] = pf;
          else allFiles.push(pf);
        }
      }
    }

    // 3. Publish to GitHub
    const publishResult = await apiCall('/api/publish', {
      method: 'POST',
      body: JSON.stringify({
        files: allFiles,
        deletedFiles,
        message: `Update from admin panel — ${new Date().toLocaleString()}`,
      }),
    });

    status.textContent = 'Published! Deploying...';
    status.className = 'publish-status success';

    // Reset state
    projects.forEach(p => delete p._edited);
    originalProjects = JSON.parse(JSON.stringify(projects));
    stagedFiles = [];
    deletedFiles = [];
    changeCount = 0;

    setTimeout(() => {
      updatePublishBar();
      showToast('Changes published — site will update in ~30 seconds');
    }, 2000);

  } catch (err) {
    status.textContent = 'Error: ' + err.message;
    status.className = 'publish-status error';
  } finally {
    btn.disabled = false;
  }
});

// ---- Toast ----
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// ---- Project Editor ----
let editorIndex = -1;
let editorVideoData = [];
let editorNewThumbFile = null;
let editorDocPosterFile = null;

function openProjectEditor(index) {
  editorIndex = index;
  editorNewThumbFile = null;
  editorDocPosterFile = null;
  const p = projects[index];

  dashboard.classList.remove('active');
  document.getElementById('projectEditor').classList.add('active');

  document.getElementById('editorProjectTitle').textContent = 'Edit: ' + p.title;
  document.getElementById('editorProjTitle').value = p.title || '';
  document.getElementById('editorProjStudio').value = p.studio || '';
  document.getElementById('editorProjRole').value = p.role || '';
  document.getElementById('editorCredits').innerHTML = p.credit || '';
  document.getElementById('editorPageType').value = p.pageType || 'single';
  document.getElementById('editorDocDesc').value = p.description || '';
  document.getElementById('editorThumbUpload').value = '';
  const thumbPrev = document.getElementById('editorThumbPreview');
  thumbPrev.src = p.thumbnail ? (p.thumbnail.startsWith('http') ? p.thumbnail : '/' + p.thumbnail) : '';
  toggleEditorDocFields();

  // Load existing scrub frames
  editorFrames = [];
  if (p.frameCount > 0) {
    for (let i = 1; i <= p.frameCount; i++) {
      editorFrames.push({
        file: null,
        preview: '/images/' + p.slug + '-frame-' + i + '.webp',
        existing: true,
      });
    }
  }
  renderEditorFrames();

  editorVideoData = (p.videoUrls && p.videoUrls.length ? p.videoUrls : ['']).map((url, i) => {
    const rawPoster = p.posters && p.posters[i] ? p.posters[i] : '';
    return {
      url,
      caption: p.videoCaptions && p.videoCaptions[i] ? p.videoCaptions[i] : '',
      posterPath: rawPoster,
      posterFile: null,
      posterPreview: rawPoster ? rawPoster.replace(/^\.\.\//, '/') : '',
    };
  });
  renderEditorVideos();
}

function closeProjectEditor() {
  document.getElementById('projectEditor').classList.remove('active');
  dashboard.classList.add('active');
}

document.getElementById('editorBackBtn').addEventListener('click', closeProjectEditor);

// Rich text toolbar
document.getElementById('rteToolbar').addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  e.preventDefault();
  const cmd = btn.dataset.cmd;
  document.execCommand(cmd, false, null);
  document.getElementById('editorCredits').focus();
  updateRteToolbar();
});
document.getElementById('editorCredits').addEventListener('keyup', updateRteToolbar);
document.getElementById('editorCredits').addEventListener('mouseup', updateRteToolbar);
function updateRteToolbar() {
  document.querySelectorAll('#rteToolbar button[data-cmd]').forEach(btn => {
    const cmd = btn.dataset.cmd;
    if (cmd === 'removeFormat' || cmd === 'insertUnorderedList') return;
    btn.classList.toggle('active', document.queryCommandState(cmd));
  });
}

document.getElementById('editorPageType').addEventListener('change', toggleEditorDocFields);
function toggleEditorDocFields() {
  const show = document.getElementById('editorPageType').value === 'documentary';
  document.getElementById('editorDocFields').classList.toggle('active', show);
}

function renderEditorVideos() {
  const list = document.getElementById('editorVideoList');
  list.innerHTML = '';
  editorVideoData.forEach((v, i) => {
    const item = document.createElement('div');
    item.className = 'video-item';
    item.draggable = true;
    item.dataset.vi = i;
    item.innerHTML = `
      <span class="drag-handle">&#8942;&#8942;</span>
      <img class="video-poster-preview" src="${v.posterPreview || ''}" alt="" onerror="this.src=''">
      <div class="video-fields">
        <input type="text" value="${esc(v.url)}" placeholder="https://www.youtube.com/embed/VIDEO_ID" class="ev-url">
        <input type="text" value="${esc(v.caption || '')}" placeholder="Caption (for grid layout)" class="ev-caption" style="margin-top:4px;">
        <input type="file" accept="image/*" class="ev-poster" style="margin-top:4px;" title="Upload poster image (shown before play)">
      </div>
      <div class="video-actions">
        <button title="Remove">&times;</button>
      </div>
    `;
    item.addEventListener('dragstart', onEditorVideoDragStart);
    item.addEventListener('dragend', onEditorVideoDragEnd);
    item.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
    item.addEventListener('drop', onEditorVideoDrop);
    item.addEventListener('dragenter', (e) => { e.preventDefault(); item.classList.add('drag-over'); });
    item.addEventListener('dragleave', () => item.classList.remove('drag-over'));

    item.querySelector('.ev-url').addEventListener('input', (e) => {
      editorVideoData[i].url = e.target.value;
    });
    item.querySelector('.ev-caption').addEventListener('input', (e) => {
      editorVideoData[i].caption = e.target.value;
    });
    item.querySelector('.ev-poster').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      editorVideoData[i].posterFile = file;
      const reader = new FileReader();
      reader.onload = (ev) => {
        editorVideoData[i].posterPreview = ev.target.result;
        item.querySelector('.video-poster-preview').src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });
    item.querySelector('.video-actions button').addEventListener('click', () => {
      if (editorVideoData.length <= 1) return;
      editorVideoData.splice(i, 1);
      renderEditorVideos();
    });
    list.appendChild(item);
  });
}

let editorDragIdx = -1;
function onEditorVideoDragStart(e) {
  editorDragIdx = parseInt(e.currentTarget.dataset.vi);
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}
function onEditorVideoDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  document.querySelectorAll('.video-item').forEach(v => v.classList.remove('drag-over'));
}
function onEditorVideoDrop(e) {
  e.preventDefault();
  const dropIdx = parseInt(e.currentTarget.dataset.vi);
  e.currentTarget.classList.remove('drag-over');
  if (editorDragIdx === dropIdx) return;
  const moved = editorVideoData.splice(editorDragIdx, 1)[0];
  editorVideoData.splice(dropIdx, 0, moved);
  renderEditorVideos();
}

document.getElementById('editorAddVideoBtn').addEventListener('click', () => {
  editorVideoData.push({ url: '', caption: '', posterPath: '', posterFile: null, posterPreview: '' });
  renderEditorVideos();
});

document.getElementById('editorThumbUpload').addEventListener('change', (e) => {
  editorNewThumbFile = e.target.files[0] || null;
  if (editorNewThumbFile) {
    const reader = new FileReader();
    reader.onload = (ev) => {
      document.getElementById('editorThumbPreview').src = ev.target.result;
    };
    reader.readAsDataURL(editorNewThumbFile);
  }
});

// ---- Scrub Frames ----
let editorFrames = []; // [{file, preview, existing}]

function renderEditorFrames() {
  const list = document.getElementById('editorFrameList');
  list.innerHTML = '';
  editorFrames.forEach((f, i) => {
    const wrap = document.createElement('div');
    wrap.className = 'frame-preview';
    wrap.innerHTML = `
      <img src="${f.preview}" style="width:100%;height:100%;object-fit:cover;border-radius:4px;">
      <span class="frame-num">${i + 1}</span>
      <button class="frame-remove" title="Remove">&times;</button>
    `;
    wrap.querySelector('.frame-remove').addEventListener('click', () => {
      editorFrames.splice(i, 1);
      renderEditorFrames();
    });
    list.appendChild(wrap);
  });
}

document.getElementById('editorFrameUpload').addEventListener('change', (e) => {
  const files = Array.from(e.target.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      editorFrames.push({ file, preview: ev.target.result, existing: false });
      renderEditorFrames();
    };
    reader.readAsDataURL(file);
  });
  e.target.value = '';
});

document.getElementById('editorClearFrames').addEventListener('click', () => {
  editorFrames = [];
  renderEditorFrames();
});

document.getElementById('editorSaveBtn').addEventListener('click', async () => {
  const p = projects[editorIndex];
  const btn = document.getElementById('editorSaveBtn');
  btn.disabled = true;
  btn.textContent = 'Saving...';
  try {
    p.title = document.getElementById('editorProjTitle').value.trim();
    p.studio = document.getElementById('editorProjStudio').value.trim();
    p.role = document.getElementById('editorProjRole').value.trim();
    p.pageType = document.getElementById('editorPageType').value;
    p.credit = document.getElementById('editorCredits').innerHTML.trim();
    p.description = document.getElementById('editorDocDesc').value.trim();
    p.videoUrls = editorVideoData.map(v => v.url).filter(Boolean);
    p.videoCaptions = editorVideoData.filter(v => v.url).map(v => v.caption || '');

    // Upload poster images
    const newPosters = [];
    for (let i = 0; i < editorVideoData.length; i++) {
      const v = editorVideoData[i];
      if (!v.url) continue;
      if (v.posterFile) {
        const base64 = await compressImage(v.posterFile);
        const posterName = p.videoUrls.length > 1
          ? `${p.slug}-poster-${i + 1}.webp`
          : `${p.slug}-poster.webp`;
        const uploadResult = await apiCall('/api/upload', {
          method: 'POST',
          body: JSON.stringify({ filename: posterName, data: base64 }),
        });
        stagedFiles.push(uploadResult.stagedFile);
        newPosters.push('../images/' + uploadResult.filename);
      } else {
        newPosters.push(v.posterPath || '');
      }
    }
    p.posters = newPosters;

    // Upload thumbnail if changed
    if (editorNewThumbFile) {
      const base64 = await compressImage(editorNewThumbFile);
      const uploadResult = await apiCall('/api/upload', {
        method: 'POST',
        body: JSON.stringify({ filename: p.slug + '.webp', data: base64 }),
      });
      stagedFiles.push(uploadResult.stagedFile);
      p.thumbnail = uploadResult.stagedFile.path;
    }

    // Upload doc poster if changed
    if (editorDocPosterFile) {
      const base64 = await compressImage(editorDocPosterFile);
      const uploadResult = await apiCall('/api/upload', {
        method: 'POST',
        body: JSON.stringify({ filename: p.slug + '-doc-poster.webp', data: base64 }),
      });
      stagedFiles.push(uploadResult.stagedFile);
      p.docPoster = '../images/' + uploadResult.filename;
    }

    // Upload scrub frames
    if (editorFrames.length > 0) {
      let frameIdx = 0;
      for (const f of editorFrames) {
        frameIdx++;
        if (f.file) {
          const base64 = await compressImage(f.file, 1200, 0.80);
          const uploadResult = await apiCall('/api/upload', {
            method: 'POST',
            body: JSON.stringify({ filename: p.slug + '-frame-' + frameIdx + '.webp', data: base64 }),
          });
          stagedFiles.push(uploadResult.stagedFile);
        }
      }
      p.frameCount = editorFrames.length;
    } else {
      p.frameCount = 0;
    }

    p._edited = true;
    markChanged();
    renderGrid();
    closeProjectEditor();
    showToast('Project updated');
  } catch (err) {
    const msg = err && err.message ? err.message : String(err);
    console.error('Editor save error:', err);
    showToast('Error: ' + msg);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Save';
  }
});

// ---- Keyboard shortcuts ----
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.getElementById('editModal').classList.remove('active');
    if (document.getElementById('projectEditor').classList.contains('active')) {
      closeProjectEditor();
    }
  }
});
</script>
</body>
</html>
