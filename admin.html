<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin — editwitheli.com</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/favicon.png">
  <style>
    :root {
      --bg: #111;
      --surface: #1a1a1a;
      --surface-hover: #242424;
      --border: #333;
      --text: #eee;
      --text-dim: #888;
      --accent: #4a9eff;
      --accent-hover: #3a8eef;
      --danger: #e55;
      --success: #4c4;
      --radius: 8px;
      --font: 'Inter', -apple-system, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ---- Login ---- */
    .login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .login-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 40px;
      width: 100%;
      max-width: 360px;
      text-align: center;
    }
    .login-box h1 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 24px;
      color: var(--text-dim);
    }
    .login-box input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font);
      margin-bottom: 16px;
    }
    .login-box input:focus { outline: none; border-color: var(--accent); }
    .login-box button {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      font-family: var(--font);
    }
    .login-box button:hover { background: var(--accent-hover); }
    .login-error {
      color: var(--danger);
      font-size: 13px;
      margin-top: 12px;
      display: none;
    }

    /* ---- Dashboard ---- */
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .top-bar h1 { font-size: 16px; font-weight: 500; }
    .top-bar .actions { display: flex; gap: 10px; }
    .btn {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      font-size: 13px;
      font-family: var(--font);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s;
    }
    .btn:hover { background: var(--surface-hover); }
    .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-danger { border-color: var(--danger); color: var(--danger); }
    .btn-danger:hover { background: var(--danger); color: #fff; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ---- Project Grid ---- */
    .project-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 40px;
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
      padding-bottom: 100px;
    }
    .admin-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      cursor: grab;
      transition: transform 0.15s, box-shadow 0.15s;
      position: relative;
    }
    .admin-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .admin-card.dragging { opacity: 0.5; transform: scale(0.95); }
    .admin-card.drag-over { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent); }
    .admin-card .card-thumb {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      display: block;
      background: #000;
    }
    .admin-card .card-thumb-wrap {
      position: relative;
      cursor: pointer;
    }
    .admin-card .card-thumb-wrap::after {
      content: 'Double-click to edit page';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 6px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 11px;
      text-align: center;
      opacity: 0;
      transition: opacity 0.15s;
      pointer-events: none;
    }
    .admin-card .card-thumb-wrap:hover::after { opacity: 1; }
    .admin-card .card-body { padding: 12px 14px; }
    .admin-card .card-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 2px;
      outline: none;
      border-radius: 3px;
      transition: background 0.15s;
    }
    .admin-card .card-title:hover { background: var(--surface-hover); }
    .admin-card .card-title:focus { background: var(--bg); box-shadow: 0 0 0 1px var(--accent); }
    .admin-card .card-studio {
      font-size: 12px;
      color: var(--text-dim);
      font-style: italic;
      outline: none;
      border-radius: 3px;
      transition: background 0.15s;
    }
    .admin-card .card-studio:hover { background: var(--surface-hover); }
    .admin-card .card-studio:focus { background: var(--bg); box-shadow: 0 0 0 1px var(--accent); }
    .admin-card .card-role {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 2px;
      outline: none;
      border-radius: 3px;
      transition: background 0.15s;
    }
    .admin-card .card-role:hover { background: var(--surface-hover); }
    .admin-card .card-role:focus { background: var(--bg); box-shadow: 0 0 0 1px var(--accent); }
    .admin-card [contenteditable]:empty::before {
      content: attr(data-placeholder);
      color: var(--text-dim);
      opacity: 0.5;
    }
    .admin-card .card-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .admin-card:hover .card-actions { opacity: 1; }
    .card-actions button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.7);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .card-actions button:hover { background: rgba(0,0,0,0.9); }
    .card-actions .delete-btn:hover { background: var(--danger); }

    /* Add card */
    .add-card {
      background: var(--surface);
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      cursor: pointer;
      transition: border-color 0.15s;
      font-size: 14px;
      color: var(--text-dim);
    }
    .add-card:hover { border-color: var(--accent); color: var(--accent); }

    /* ---- Modal ---- */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 100%;
      max-width: 560px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 28px;
    }
    .modal h2 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-dim);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font);
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .video-url-group {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .video-url-group input { flex: 1; }
    .video-url-group button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-dim);
      cursor: pointer;
      flex-shrink: 0;
      font-size: 16px;
    }
    .video-url-group button:hover { border-color: var(--danger); color: var(--danger); }
    .add-video-btn {
      font-size: 13px;
      color: var(--accent);
      cursor: pointer;
      background: none;
      border: none;
      font-family: var(--font);
      padding: 4px 0;
    }
    .add-video-btn:hover { text-decoration: underline; }
    .thumb-preview {
      width: 120px;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 4px;
      background: #000;
      display: block;
      margin-bottom: 8px;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    /* ---- Publish Bar ---- */
    .publish-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 14px 24px;
      display: none;
      align-items: center;
      justify-content: space-between;
      z-index: 150;
    }
    .publish-bar.active { display: flex; }
    .publish-bar .change-count {
      font-size: 14px;
      color: var(--text-dim);
    }
    .publish-bar .change-count strong {
      color: var(--accent);
    }
    .publish-status {
      font-size: 13px;
      margin-left: 12px;
    }
    .publish-status.success { color: var(--success); }
    .publish-status.error { color: var(--danger); }

    /* ---- Toast ---- */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 12px 24px;
      border-radius: var(--radius);
      font-size: 14px;
      z-index: 300;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; }

    /* Drag ghost */
    .drag-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 999;
      opacity: 0.8;
      transform: rotate(3deg);
    }

    /* ---- Project Editor ---- */
    .project-editor { display: none; }
    .project-editor.active { display: block; }
    .editor-top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .editor-top-bar h1 {
      font-size: 16px;
      font-weight: 500;
      flex: 1;
      margin: 0 20px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .editor-body {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
      padding-bottom: 120px;
    }
    .editor-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }
    .editor-section h3 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .editor-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 12px;
    }
    .editor-field label {
      display: block;
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 6px;
      font-weight: 500;
    }
    .editor-field input,
    .editor-field select,
    .editor-section > textarea {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font);
    }
    .editor-field input:focus,
    .editor-field select:focus,
    .editor-section > textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .editor-section > textarea {
      resize: vertical;
      min-height: 100px;
    }
    .video-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 8px;
      transition: border-color 0.15s;
    }
    .video-item.dragging { opacity: 0.5; }
    .video-item.drag-over { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
    .video-item .drag-handle {
      color: var(--text-dim);
      cursor: grab;
      font-size: 16px;
      user-select: none;
      flex-shrink: 0;
      letter-spacing: -2px;
      padding: 8px 4px;
      border-radius: 4px;
      transition: background 0.15s, color 0.15s;
    }
    .video-item .drag-handle:hover { background: var(--surface-hover); color: var(--text); }
    .video-item .drag-handle:active { cursor: grabbing; }
    .video-item .video-poster-preview {
      width: 100px;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 4px;
      background: #333;
      flex-shrink: 0;
      display: block;
    }
    .video-item .video-fields {
      flex: 1;
      min-width: 0;
    }
    .video-item .video-fields input[type="text"] {
      width: 100%;
      padding: 8px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 13px;
      font-family: var(--font);
      margin-bottom: 6px;
    }
    .video-item .video-fields input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
    }
    .video-item .video-fields input[type="file"] {
      font-size: 12px;
      color: var(--text-dim);
    }
    .video-item .video-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex-shrink: 0;
    }
    .video-item .video-actions button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-dim);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .video-item .video-actions button:hover {
      border-color: var(--danger);
      color: var(--danger);
    }
    .editor-add-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: none;
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      color: var(--text-dim);
      font-size: 13px;
      cursor: pointer;
      font-family: var(--font);
      margin-top: 8px;
    }
    .editor-add-btn:hover { border-color: var(--accent); color: var(--accent); }
    .doc-fields { display: none; margin-top: 16px; }
    .doc-fields.active { display: block; }
    /* Scrub frame previews */
    .frame-preview {
      width: 100px;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 4px;
      background: #333;
      display: block;
      position: relative;
    }
    .frame-preview .frame-num {
      position: absolute;
      top: 3px;
      left: 5px;
      font-size: 10px;
      color: #fff;
      background: rgba(0,0,0,0.6);
      padding: 1px 5px;
      border-radius: 3px;
    }
    .frame-preview .frame-remove {
      position: absolute;
      top: 3px;
      right: 3px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .frame-preview:hover .frame-remove { opacity: 1; }
    .frame-preview .frame-remove:hover { background: var(--danger); }
    /* Rich text editor */
    .rte-toolbar {
      display: flex;
      gap: 4px;
      padding: 6px 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: var(--radius) var(--radius) 0 0;
    }
    .rte-toolbar button {
      padding: 4px 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-dim);
      cursor: pointer;
      font-family: var(--font);
      font-size: 13px;
      line-height: 1.4;
    }
    .rte-toolbar button:hover { background: var(--surface-hover); color: var(--text); }
    .rte-toolbar button.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .rte-editor {
      min-height: 100px;
      padding: 12px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 0 0 var(--radius) var(--radius);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font);
      outline: none;
      line-height: 1.6;
    }
    .rte-editor:focus { border-color: var(--accent); }
    .rte-editor strong, .rte-editor b { font-weight: 600; }
    .rte-editor em, .rte-editor i { font-style: italic; }
    .rte-editor:empty::before {
      content: 'Editor.';
      color: var(--text-dim);
      opacity: 0.5;
    }
    /* ---- Tab Nav ---- */
    .top-bar .tab-nav { display: flex; gap: 4px; }
    .top-bar .tab-nav button {
      padding: 6px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: transparent;
      color: var(--text-dim);
      font-size: 13px;
      font-family: var(--font);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s;
    }
    .top-bar .tab-nav button:hover { color: var(--text); background: var(--surface-hover); }
    .top-bar .tab-nav button.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* ---- About Editor ---- */
    .about-editor { display: none; }
    .about-editor.active { display: block; }
    .about-editor-body {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
      padding-bottom: 120px;
    }
    .about-bio-para {
      position: relative;
      margin-bottom: 10px;
    }
    .about-bio-para textarea {
      width: 100%;
      padding: 10px 14px;
      padding-right: 40px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font);
      resize: vertical;
      min-height: 80px;
    }
    .about-bio-para textarea:focus { outline: none; border-color: var(--accent); }
    .about-bio-para .remove-para {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-dim);
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .about-bio-para .remove-para:hover { border-color: var(--danger); color: var(--danger); }
    .about-photo-item {
      display: inline-block;
      position: relative;
      margin: 6px;
    }
    .about-photo-item img {
      width: 140px;
      aspect-ratio: 4/3;
      object-fit: cover;
      border-radius: 6px;
      background: #333;
      display: block;
    }
    .about-photo-item .photo-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: rgba(0,0,0,0.7);
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .about-photo-item:hover .photo-remove { opacity: 1; }
    .about-photo-item .photo-remove:hover { background: var(--danger); }

    @media (max-width: 1024px) {
      .project-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .project-grid { grid-template-columns: 1fr; }
      .editor-row { grid-template-columns: 1fr; }
      .video-item { flex-wrap: wrap; }
      .video-item .video-poster-preview { width: 80px; }
      .about-photo-item img { width: 100px; }
    }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>editwitheli.com admin</h1>
      <form id="loginForm">
        <input type="text" id="patInput" placeholder="GitHub Personal Access Token" autocomplete="off" spellcheck="false">
        <button type="submit">Log In</button>
      </form>
      <div class="login-error" id="loginError">Invalid token. Try again.</div>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <div class="top-bar">
      <div class="tab-nav">
        <button class="active" id="tabProjects">Projects</button>
        <button id="tabAbout">About</button>
      </div>
      <div class="actions">
        <button class="btn" id="refreshBtn" title="Refresh from live site">Refresh</button>
        <button class="btn" id="logoutBtn">Log Out</button>
      </div>
    </div>

    <div class="project-grid" id="projectGrid"></div>

    <!-- Publish Bar -->
    <div class="publish-bar" id="publishBar">
      <div>
        <span class="change-count"><strong id="changeCount">0</strong> unsaved changes</span>
        <span class="publish-status" id="publishStatus"></span>
      </div>
      <div class="actions">
        <button class="btn" id="discardBtn">Discard</button>
        <button class="btn btn-primary" id="publishBtn">Publish</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h2 id="modalTitle">Edit Project</h2>
      <div class="form-group">
        <label>Title</label>
        <input type="text" id="editTitle" placeholder="Project title">
      </div>
      <div class="form-group">
        <label>Studio</label>
        <input type="text" id="editStudio" placeholder="Studio name (leave blank if none)">
      </div>
      <div class="form-group">
        <label>Role</label>
        <input type="text" id="editRole" placeholder="Your role">
      </div>
      <div class="form-group">
        <label>Slug (URL path)</label>
        <input type="text" id="editSlug" placeholder="project-slug">
      </div>
      <div class="form-group">
        <label>Video URLs</label>
        <div id="videoUrlList"></div>
        <button class="add-video-btn" id="addVideoBtn">+ Add another video</button>
      </div>
      <div class="form-group">
        <label>Page Type</label>
        <select id="editPageType">
          <option value="single">Single Video</option>
          <option value="stacked">Stacked Videos</option>
          <option value="documentary">Documentary</option>
        </select>
      </div>
      <div class="form-group">
        <label>Credits (HTML)</label>
        <textarea id="editCredit" placeholder="Editor."></textarea>
      </div>
      <div class="form-group" id="docDescGroup" style="display:none">
        <label>Documentary Description</label>
        <textarea id="editDocDesc" placeholder="Short description for documentary sidebar"></textarea>
      </div>
      <div class="form-group">
        <label>Thumbnail</label>
        <img class="thumb-preview" id="thumbPreview" src="" alt="Thumbnail">
        <input type="file" id="thumbUpload" accept="image/*">
      </div>
      <div class="modal-actions">
        <button class="btn" id="editCancel">Cancel</button>
        <button class="btn btn-primary" id="editSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Project Editor -->
  <div class="project-editor" id="projectEditor">
    <div class="editor-top-bar">
      <button class="btn" id="editorBackBtn">&larr; Back</button>
      <h1 id="editorProjectTitle">Edit Project</h1>
      <button class="btn btn-primary" id="editorSaveBtn">Save</button>
    </div>
    <div class="editor-body">
      <!-- Project Info -->
      <div class="editor-section">
        <h3>Project Info</h3>
        <div class="editor-row">
          <div class="editor-field">
            <label>Title</label>
            <input type="text" id="editorProjTitle" placeholder="Project title">
          </div>
          <div class="editor-field">
            <label>Studio</label>
            <input type="text" id="editorProjStudio" placeholder="Studio name (optional)">
          </div>
        </div>
        <div class="editor-row">
          <div class="editor-field">
            <label>Role</label>
            <input type="text" id="editorProjRole" placeholder="Editor">
          </div>
        </div>
      </div>
      <!-- Homepage Thumbnail -->
      <div class="editor-section">
        <h3>Homepage Thumbnail</h3>
        <p style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">The image shown on the main grid. Separate from the video poster screenshots below.</p>
        <img id="editorThumbPreview" style="width:200px;aspect-ratio:16/9;object-fit:cover;border-radius:4px;background:#333;display:block;margin-bottom:10px;" src="" alt="">
        <input type="file" id="editorThumbUpload" accept="image/*">
      </div>
      <!-- Hover Preview Video -->
      <div class="editor-section">
        <h3>Hover Preview Video</h3>
        <p style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">Upload a short (3–5 sec) MP4 clip. It auto-plays when visitors hover the thumbnail on the homepage.</p>
        <video id="editorPreviewVideo" style="width:200px;aspect-ratio:16/9;object-fit:cover;border-radius:4px;background:#333;display:block;margin-bottom:10px;" muted loop playsinline></video>
        <div style="display:flex;gap:10px;align-items:center;">
          <input type="file" id="editorPreviewUpload" accept="video/mp4,video/webm,.mp4,.webm">
          <button class="btn btn-danger" id="editorClearPreview" style="font-size:12px;padding:6px 12px;">Clear</button>
        </div>
      </div>

      <!-- Videos -->
      <div class="editor-section">
        <h3>Videos</h3>
        <p style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">Each video has its own poster image (the still shown before pressing play). Drag to reorder.</p>
        <div id="editorVideoList"></div>
        <button class="editor-add-btn" id="editorAddVideoBtn">+ Add Video</button>
      </div>
      <!-- Credits -->
      <div class="editor-section">
        <h3>Credits</h3>
        <div class="rte-toolbar" id="rteToolbar">
          <button type="button" data-cmd="bold" title="Bold"><b>B</b></button>
          <button type="button" data-cmd="italic" title="Italic"><i>I</i></button>
          <button type="button" data-cmd="insertUnorderedList" title="Bullet list">&#8226; List</button>
          <button type="button" data-cmd="removeFormat" title="Clear formatting">Clear</button>
        </div>
        <div class="rte-editor" id="editorCredits" contenteditable="true"></div>
      </div>
      <!-- Page Settings -->
      <div class="editor-section">
        <h3>Page Settings</h3>
        <div class="editor-row">
          <div class="editor-field">
            <label>Page Type</label>
            <select id="editorPageType">
              <option value="single">Single Video</option>
              <option value="stacked">Stacked Videos</option>
              <option value="grid">Video Grid (2-up with captions)</option>
              <option value="documentary">Documentary</option>
            </select>
          </div>
          <div class="editor-field" id="editorFourUpField" style="display:none; margin-top:8px;">
            <label>Show 4-up row after video #</label>
            <input type="number" id="editorFourUpAfter" min="0" value="0" style="width:60px;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:14px;">
            <span style="font-size:11px;color:var(--text-dim);margin-left:6px;">0 = all in 2-up grid</span>
          </div>
        </div>
        <div class="doc-fields" id="editorDocFields">
          <div class="editor-field" style="margin-bottom: 12px;">
            <label>Documentary Description</label>
            <textarea id="editorDocDesc" style="width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:14px;font-family:var(--font);resize:vertical;min-height:60px;" placeholder="Short description..."></textarea>
          </div>
          <div class="editor-field">
            <label>Documentary Poster Image</label>
            <input type="file" id="editorDocPosterUpload" accept="image/*">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- About Editor -->
  <div class="about-editor" id="aboutEditor">
    <div class="about-editor-body">
      <!-- Heading -->
      <div class="editor-section">
        <h3>Heading</h3>
        <input type="text" id="aboutHeading" value="" style="width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:14px;font-family:var(--font);">
      </div>
      <!-- Bio Paragraphs -->
      <div class="editor-section">
        <h3>Bio Paragraphs</h3>
        <div id="aboutBioList"></div>
        <button class="editor-add-btn" id="aboutAddParaBtn">+ Add Paragraph</button>
      </div>
      <!-- Contact Line -->
      <div class="editor-section">
        <h3>Contact Line (HTML)</h3>
        <input type="text" id="aboutContact" value="" placeholder='e.g. Drop me a line: &lt;a href="mailto:..."&gt;email&lt;/a&gt;' style="width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:14px;font-family:var(--font);">
      </div>
      <!-- Headshot -->
      <div class="editor-section">
        <h3>Headshot</h3>
        <img id="aboutHeadshotPreview" style="width:180px;aspect-ratio:3/4;object-fit:cover;border-radius:6px;background:#333;display:block;margin-bottom:10px;" src="" alt="">
        <input type="file" id="aboutHeadshotUpload" accept="image/*">
      </div>
      <!-- Photo Grid -->
      <div class="editor-section">
        <h3>Photo Grid</h3>
        <div id="aboutPhotoGrid"></div>
        <div style="margin-top:10px;">
          <input type="file" id="aboutPhotoUpload" accept="image/*" multiple>
        </div>
      </div>
      <!-- Save -->
      <div style="margin-top:20px;display:flex;justify-content:flex-end;">
        <button class="btn btn-primary" id="aboutSaveBtn" style="padding:12px 28px;">Save About Page</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

<script>
const GITHUB_API = 'https://api.github.com';
const OWNER = 'harriganeli-source';
const REPO = 'portfolio';
const BRANCH = 'main';
let token = localStorage.getItem('admin_token') || '';
let projects = [];
let stagedFiles = [];
let deletedFiles = [];
let originalProjects = [];
let editingIndex = -1;
let newThumbFile = null;

// ---- Auth ----
const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');
const loginScreen = document.getElementById('loginScreen');
const dashboard = document.getElementById('dashboard');

function handleAuthFailure() {
  token = '';
  localStorage.removeItem('admin_token');
  loginScreen.style.display = 'flex';
  dashboard.classList.remove('active');
  document.getElementById('projectEditor').classList.remove('active');
  document.getElementById('aboutEditor').classList.remove('active');
}

loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  loginError.style.display = 'none';
  const pat = document.getElementById('patInput').value.trim();
  if (!pat) { loginError.textContent = 'Token required'; loginError.style.display = 'block'; return; }
  try {
    const r = await fetch(`${GITHUB_API}/user`, {
      headers: { Authorization: `token ${pat}` },
    });
    if (!r.ok) throw new Error('Invalid token');
    token = pat;
    localStorage.setItem('admin_token', token);
    showDashboard();
  } catch (err) {
    loginError.textContent = err.message || 'Invalid token';
    loginError.style.display = 'block';
  }
});

document.getElementById('logoutBtn').addEventListener('click', () => {
  token = '';
  localStorage.removeItem('admin_token');
  loginScreen.style.display = 'flex';
  dashboard.classList.remove('active');
});

// Auto-login if token exists
if (token) {
  showDashboard();
} else {
  loginScreen.style.display = 'flex';
}

async function showDashboard() {
  loginScreen.style.display = 'none';
  dashboard.classList.add('active');
  await loadProjects();
}

// ---- GitHub API ----
async function githubGet(path) {
  const r = await fetch(`${GITHUB_API}/repos/${OWNER}/${REPO}/contents/${path}`, {
    headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' },
  });
  if (r.status === 401) { handleAuthFailure(); throw new Error('Session expired'); }
  if (!r.ok) throw new Error(`GitHub GET ${path}: ${r.status}`);
  const json = await r.json();
  const binary = atob(json.content.replace(/\n/g, ''));
  const bytes = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
  return new TextDecoder().decode(bytes);
}

async function ghFetch(path, options = {}) {
  const url = `${GITHUB_API}/repos/${OWNER}/${REPO}${path}`;
  const r = await fetch(url, {
    ...options,
    headers: {
      Authorization: `token ${token}`,
      Accept: 'application/vnd.github.v3+json',
      'Content-Type': 'application/json',
      ...(options.headers || {}),
    },
  });
  if (r.status === 401) { handleAuthFailure(); throw new Error('Session expired'); }
  if (!r.ok) {
    const text = await r.text();
    throw new Error(`GitHub ${options.method || 'GET'} ${path}: ${r.status} ${text}`);
  }
  return r.json();
}

async function commitToGitHub(files, deletedPaths, message) {
  if ((!files || !files.length) && (!deletedPaths || !deletedPaths.length)) {
    throw new Error('No changes to publish');
  }
  const ref = await ghFetch(`/git/refs/heads/${BRANCH}`);
  const latestSha = ref.object.sha;
  const commit = await ghFetch(`/git/commits/${latestSha}`);
  const baseTreeSha = commit.tree.sha;
  const treeItems = [];
  if (files) {
    for (const file of files) {
      const blob = await ghFetch('/git/blobs', {
        method: 'POST',
        body: JSON.stringify({ content: file.content, encoding: file.encoding === 'base64' ? 'base64' : 'utf-8' }),
      });
      treeItems.push({ path: file.path, mode: '100644', type: 'blob', sha: blob.sha });
    }
  }
  if (deletedPaths) {
    for (const p of deletedPaths) {
      treeItems.push({ path: p, mode: '100644', type: 'blob', sha: null });
    }
  }
  const newTree = await ghFetch('/git/trees', {
    method: 'POST',
    body: JSON.stringify({ base_tree: baseTreeSha, tree: treeItems }),
  });
  const newCommit = await ghFetch('/git/commits', {
    method: 'POST',
    body: JSON.stringify({ message: message || `Update from admin — ${new Date().toLocaleString()}`, tree: newTree.sha, parents: [latestSha] }),
  });
  await ghFetch(`/git/refs/heads/${BRANCH}`, {
    method: 'PATCH',
    body: JSON.stringify({ sha: newCommit.sha }),
  });
  return { commitSha: newCommit.sha };
}

// ---- Local Upload Staging ----
function stageUpload(filename, base64) {
  const outputFilename = filename.replace(/\.\w+$/, '.webp');
  const filePath = `images/${outputFilename}`;
  return {
    stagedFile: { path: filePath, content: base64, encoding: 'base64' },
    filename: outputFilename,
  };
}

function stageVideoUpload(filename, base64) {
  const filePath = `images/${filename}`;
  return {
    stagedFile: { path: filePath, content: base64, encoding: 'base64' },
    filename,
  };
}

// ---- HTML Parsers & Generators (ported from server) ----
function parseProjects(html) {
  const projects = [];
  const cardRegex = /<a href="projects\/([^"]+)" class="project-card[^"]*">\s*<div class="project-thumb"[^>]*>\s*<img src="([^"]+)"[^>]*>\s*(?:<div class="laurels-overlay">[\s\S]*?<\/div>\s*)?<div class="project-info">\s*<span class="project-title">([\s\S]*?)<\/span>\s*<span class="project-role">([\s\S]*?)<\/span>\s*<\/div>\s*<\/div>\s*<\/a>/g;
  let m;
  while ((m = cardRegex.exec(html)) !== null) {
    const slug = m[1].replace('.html', '');
    const thumbnail = m[2];
    const titleHtml = m[3];
    const role = m[4].replace(/&amp;/g, '&').replace(/&#39;/g, "'").trim();
    let title, studio = '', hasLaurels = false;
    const studioMatch = titleHtml.match(/^(.*?)(?:\s*·\s*(?:for\s*)?<span class="studio">(.*?)<\/span>)?$/);
    if (studioMatch) {
      title = studioMatch[1].replace(/&#39;/g, "'").replace(/&amp;/g, '&').trim();
      studio = (studioMatch[2] || '').replace(/&amp;/g, '&').replace(/&#39;/g, "'").trim();
    } else {
      title = titleHtml.replace(/&#39;/g, "'").replace(/&amp;/g, '&').trim();
    }
    hasLaurels = m[0].includes('laurels-overlay');
    const framesMatch = m[0].match(/data-frames="(\d+)"/);
    const frameCount = framesMatch ? parseInt(framesMatch[1], 10) : 0;
    const previewMatch = m[0].match(/data-preview="([^"]+)"/);
    const previewVideo = previewMatch ? previewMatch[1] : '';
    projects.push({ slug, title, studio, role, thumbnail, hasLaurels, frameCount, previewVideo });
  }
  return projects;
}

function parseProjectPage(html) {
  const data = {};
  const videoMatches = [...html.matchAll(/data-src="([^"]+)"/g)];
  data.videoUrls = videoMatches.map(m => m[1]);
  const posterMatches = [...html.matchAll(/class="video-poster"[^>]*src="([^"]+)"|src="([^"]+)"[^>]*class="video-poster"/g)];
  data.posters = posterMatches.map(m => m[1] || m[2]);
  // Extract per-video preview paths from data-preview attributes on .video-container
  const containerMatches = [...html.matchAll(/<div class="video-container"[^>]*>/g)];
  data.videoPreviews = containerMatches.map(m => {
    const previewMatch = m[0].match(/data-preview="([^"]+)"/);
    return previewMatch ? previewMatch[1] : '';
  });
  const creditMatch = html.match(/<div class="project-credit">\s*<p>([\s\S]*?)<\/p>/);
  if (creditMatch) data.credit = creditMatch[1].trim();
  if (html.includes('doc-layout')) data.pageType = 'documentary';
  else if (html.includes('videos-grid')) data.pageType = 'grid';
  else if (html.includes('videos-stacked')) data.pageType = 'stacked';
  else data.pageType = 'single';
  // Detect 2+4 split: first .videos-stacked followed by .videos-four-up
  if (data.pageType === 'stacked' && html.includes('videos-four-up')) {
    const topMatches = html.match(/<div class="videos-stacked">([\s\S]*?)<\/div>\s*<div class="videos-stacked videos-four-up">/);
    if (topMatches) {
      const topCount = (topMatches[1].match(/class="video-container"/g) || []).length;
      data.fourUpAfter = topCount;
    }
  }
  const captionMatches = [...html.matchAll(/<p class="video-caption">([\s\S]*?)<\/p>/g)];
  data.videoCaptions = captionMatches.map(m => m[1].trim());
  if (data.pageType === 'documentary') {
    const descMatch = html.match(/<p class="doc-description">([\s\S]*?)<\/p>/);
    if (descMatch) data.description = descMatch[1].trim();
    const posterImgMatch = html.match(/<div class="doc-poster">\s*<img src="([^"]+)"/);
    if (posterImgMatch) data.docPoster = posterImgMatch[1];
  }
  return data;
}

function generateCardHtml(project) {
  const titleEsc = project.title.replace(/&/g, '&amp;').replace(/'/g, '&#39;');
  const roleEsc = project.role.replace(/&/g, '&amp;').replace(/'/g, '&#39;');
  const studioEsc = project.studio ? project.studio.replace(/&/g, '&amp;').replace(/'/g, '&#39;') : '';
  let titleSpan;
  if (studioEsc) {
    titleSpan = `<span class="project-title">${titleEsc} · <span class="studio">${studioEsc}</span></span>`;
  } else {
    titleSpan = `<span class="project-title">${titleEsc}</span>`;
  }
  const previewAttr = project.previewVideo ? ` data-preview="${project.previewVideo}"` : '';
  const framesAttr = project.frameCount > 0 ? ` data-frames="${project.frameCount}"` : '';
  return `        <a href="projects/${project.slug}.html" class="project-card grid-item fade-in">
          <div class="project-thumb"${previewAttr}${framesAttr}>
            <img src="${project.thumbnail}" alt="${titleEsc}" loading="lazy">
            <div class="project-info">
              ${titleSpan}
              <span class="project-role">${roleEsc}</span>
            </div>
          </div>
        </a>`;
}

function generateProjectPage(project, pageData) {
  const titleEsc = project.title.replace(/&/g, '&amp;').replace(/'/g, '&#39;');
  const previews = pageData.videoPreviews || [];
  let videoHtml = '';
  if (pageData.pageType === 'stacked' && pageData.videoUrls.length > 1) {
    const captions = pageData.videoCaptions || [];
    const fourUpAfter = pageData.fourUpAfter || 0;
    const makeCard = (url, i) => {
      const poster = pageData.posters && pageData.posters[i] ? pageData.posters[i] : '';
      const previewAttr = previews[i] ? ` data-preview="${previews[i]}"` : '';
      const caption = captions[i] ? `\n          <p class="video-caption">${captions[i]}</p>` : '';
      return `          <div class="video-card">
            <div class="video-container" data-src="${url}"${previewAttr}>
              <img src="${poster}" alt="${titleEsc}" class="video-poster">
              <button class="play-btn" aria-label="Play video"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><polygon points="5,3 19,12 5,21"/></svg></button>
            </div>${caption}
          </div>`;
    };
    if (fourUpAfter > 0 && fourUpAfter < pageData.videoUrls.length) {
      const topVideos = pageData.videoUrls.slice(0, fourUpAfter).map(makeCard).join('\n');
      const bottomVideos = pageData.videoUrls.slice(fourUpAfter).map((url, i) => makeCard(url, i + fourUpAfter)).join('\n');
      videoHtml = `        <div class="videos-stacked">\n${topVideos}\n        </div>\n        <div class="videos-stacked videos-four-up">\n${bottomVideos}\n        </div>`;
    } else {
      const videos = pageData.videoUrls.map(makeCard).join('\n');
      videoHtml = `        <div class="videos-stacked">\n${videos}\n        </div>`;
    }
  } else {
    const url = pageData.videoUrls[0] || '';
    const poster = pageData.posters && pageData.posters[0] ? pageData.posters[0] : '';
    const previewAttr = previews[0] ? ` data-preview="${previews[0]}"` : '';
    const caption = pageData.videoCaptions && pageData.videoCaptions[0] ? `\n        <p class="video-caption">${pageData.videoCaptions[0]}</p>` : '';
    videoHtml = `        <div class="video-container" data-src="${url}"${previewAttr}>
          <img src="${poster}" alt="${titleEsc}" class="video-poster">
          <button class="play-btn" aria-label="Play video"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><polygon points="5,3 19,12 5,21"/></svg></button>
        </div>${caption}`;
  }
  const credit = pageData.credit || project.role.replace(/&/g, '&amp;') + '.';
  let mainContent;
  if (pageData.pageType === 'grid') {
    const roleEsc = (project.role || '').replace(/&/g, '&amp;');
    const cards = pageData.videoUrls.map((url, i) => {
      const poster = pageData.posters && pageData.posters[i] ? pageData.posters[i] : '';
      const caption = pageData.videoCaptions && pageData.videoCaptions[i] ? pageData.videoCaptions[i] : '';
      const previewAttr = previews[i] ? ` data-preview="${previews[i]}"` : '';
      return `        <div class="video-card">
          <div class="video-container" data-src="${url}"${previewAttr}>
            <img src="${poster}" alt="${titleEsc}" class="video-poster">
            <button class="play-btn" aria-label="Play video"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><polygon points="5,3 19,12 5,21"/></svg></button>
          </div>
          <p class="video-caption">${caption}</p>
        </div>`;
    }).join('\n');
    mainContent = `      <p class="project-role-label">${roleEsc}.</p>
      <div class="videos-grid">
${cards}
      </div>`;
  } else if (pageData.pageType === 'documentary') {
    const desc = pageData.description || '';
    const docPoster = pageData.docPoster || '';
    mainContent = `      <div class="doc-layout">
        <div class="doc-main">
${videoHtml}
          <div class="laurels-marquee">
            <div class="laurels-track">
              <img src="../images/laurels-strip.webp" alt="Festival Laurels">
              <img src="../images/laurels-strip.webp" alt="Festival Laurels">
            </div>
          </div>
          <p class="doc-description">${desc}</p>
        </div>
        <div class="doc-sidebar">
          <div class="doc-poster">
            <img src="${docPoster}" alt="${titleEsc} - Poster">
          </div>
        </div>
      </div>`;
  } else {
    mainContent = `      <div class="project-layout">
${videoHtml}
      </div>`;
  }
  const studioSuffix = project.studio ? ` \u2014 ${project.studio}` : '';
  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${project.title}${studioSuffix} \u2014 Eli Harrigan</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="icon" type="image/png" href="../images/favicon.png">
  <link rel="apple-touch-icon" href="../images/apple-touch-icon.png">
</head>
<body>
  <nav>
    <a href="../index.html" class="nav-logo">Eli Harr<span class="logo-i">\u0131<span class="i-dot"></span></span>gan</a>
    <ul class="nav-links nav-menu">
      <li><a href="../index.html" class="active">video</a></li>
      <li><a href="../photography.html">photography</a></li>
      <li><a href="../about.html">about</a></li>
    </ul>
    <div class="hamburger" aria-label="Toggle menu"><span></span><span></span><span></span></div>
  </nav>
  <main>
    <div class="container-narrow">
      <a href="../index.html" class="back-link">Back to Video</a>
      <h1 class="project-heading">${titleEsc}</h1>
      <div class="project-credit">
        <p>${credit}</p>
      </div>
${mainContent}
    </div>
  </main>
  <footer><p>&copy; 2026 Eli Harrigan</p></footer>
  \x3cscript src="../js/main.js">\x3c/script>
</body>
</html>
`;
}

function rebuildIndexHtml(originalHtml, projects) {
  const cardsHtml = projects.map(p => generateCardHtml(p)).join('\n\n');
  const gridStart = originalHtml.indexOf('<div class="grid-projects">');
  const gridContentStart = originalHtml.indexOf('>', gridStart) + 1;
  let depth = 1;
  let i = gridContentStart;
  while (depth > 0 && i < originalHtml.length) {
    const nextOpen = originalHtml.indexOf('<div', i);
    const nextClose = originalHtml.indexOf('</div>', i);
    if (nextClose === -1) break;
    if (nextOpen !== -1 && nextOpen < nextClose) {
      depth++;
      i = nextOpen + 4;
    } else {
      depth--;
      if (depth === 0) {
        return originalHtml.substring(0, gridContentStart) + '\n\n' + cardsHtml + '\n\n\n      ' + originalHtml.substring(nextClose);
      }
      i = nextClose + 6;
    }
  }
  return originalHtml;
}

function parseAboutPage(html) {
  const data = {};
  const headingMatch = html.match(/<h1>([\s\S]*?)<\/h1>/);
  data.heading = headingMatch ? headingMatch[1].trim() : 'Hey there!';
  const bioMatch = html.match(/<div class="about-bio">([\s\S]*?)<\/div>/);
  if (bioMatch) {
    const bioHtml = bioMatch[1];
    const paragraphs = [...bioHtml.matchAll(/<p(?:\s+class="about-contact")?>([\s\S]*?)<\/p>/g)];
    data.bioParas = [];
    data.contactHtml = '';
    for (const p of paragraphs) {
      if (p[0].includes('about-contact')) {
        data.contactHtml = p[1].trim();
      } else {
        data.bioParas.push(p[1].trim());
      }
    }
  } else {
    data.bioParas = [];
    data.contactHtml = '';
  }
  const headshotMatch = html.match(/<div class="about-headshot">\s*<img src="([^"]+)"/);
  data.headshotSrc = headshotMatch ? headshotMatch[1] : 'images/headshot.webp';
  const photoGridMatch = html.match(/<div class="about-photo-grid">([\s\S]*?)<\/div>\s*<\/main>/);
  if (photoGridMatch) {
    data.photos = [...photoGridMatch[1].matchAll(/<img src="([^"]+)"/g)].map(m => m[1]);
  } else {
    data.photos = [];
  }
  return data;
}

function generateAboutPage(data) {
  const bioParasHtml = data.bioParas.map(p => `            <p>${p}</p>`).join('\n');
  const contactLine = data.contactHtml
    ? `\n            <p class="about-contact">${data.contactHtml}</p>`
    : '';
  const photosHtml = data.photos.map(src =>
    `      <div class="about-photo"><img src="${src}" alt="" loading="lazy"></div>`
  ).join('\n');
  const logosHtml = (data._logosHtml || '').trim();
  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eli Harrigan \u2014 About</title>
  <meta name="description" content="About Eli Harrigan \u2014 Multimedia producer, director, editor, and photographer.">
  <meta property="og:title" content="Eli Harrigan \u2014 About">
  <meta property="og:description" content="Multimedia producer, director, editor, and photographer.">
  <meta property="og:image" content="https://editwitheli.com/images/og-image.jpg">
  <meta property="og:url" content="https://editwitheli.com/about">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://editwitheli.com/images/og-image.jpg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
</head>
<body class="page-about">

  <nav>
    <a href="index.html" class="nav-logo">Eli Harr<span class="logo-i">\u0131<span class="i-dot"></span></span>gan</a>
    <ul class="nav-links nav-menu">
      <li><a href="index.html">video</a></li>
      <li><a href="photography.html">photography</a></li>
      <li><a href="about.html" class="active">about</a></li>
    </ul>
    <div class="hamburger" aria-label="Toggle menu">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </nav>

  <main>
    <!-- About content -->
    <div class="about-content">
      <div class="about-content-inner">
        <div class="about-hero">
          <div class="about-bio">
            <h1>${data.heading}</h1>
${bioParasHtml}${contactLine}
          </div>
          <div class="about-headshot">
            <img src="${data.headshotSrc}" alt="Eli Harrigan">
          </div>
        </div>
      </div>
    </div>

    <!-- Client logos -->
${logosHtml}

    <!-- Photo grids -->
    <div class="about-photo-grid">
${photosHtml}
    </div>
  </main>

  <footer>
    <p>&copy; 2026 Eli Harrigan</p>
  </footer>

  \x3cscript src="js/main.js">\x3c/script>
</body>
</html>
`;
}

// ---- Projects ----
async function loadProjects() {
  try {
    const indexHtml = await githubGet('index.html');
    const parsed = parseProjects(indexHtml);
    const enriched = await Promise.all(parsed.map(async (p) => {
      try {
        const pageHtml = await githubGet(`projects/${p.slug}.html`);
        const pageData = parseProjectPage(pageHtml);
        return { ...p, ...pageData };
      } catch {
        return { ...p, videoUrls: [], pageType: 'single', credit: '' };
      }
    }));
    projects = enriched;
    originalProjects = JSON.parse(JSON.stringify(enriched));
    stagedFiles = [];
    deletedFiles = [];
    renderGrid();
    updatePublishBar();
  } catch (err) {
    showToast('Failed to load projects: ' + err.message);
  }
}

document.getElementById('refreshBtn').addEventListener('click', loadProjects);

function renderGrid() {
  const grid = document.getElementById('projectGrid');
  grid.innerHTML = '';

  projects.forEach((p, i) => {
    const card = document.createElement('div');
    card.className = 'admin-card';
    card.draggable = true;
    card.dataset.index = i;

    const thumbSrc = p._thumbPreview || (p.thumbnail.startsWith('http') ? p.thumbnail : `/${p.thumbnail}`);

    card.innerHTML = `
      <div class="card-actions">
        <button class="edit-btn" title="Edit page" data-index="${i}">&#9998;</button>
        <button class="delete-btn" title="Delete" data-index="${i}">&times;</button>
      </div>
      <div class="card-thumb-wrap">
        <img class="card-thumb" src="${thumbSrc}" alt="${esc(p.title)}" onerror="this.style.background='#333'">
      </div>
      <div class="card-body">
        <div class="card-title" contenteditable="true" data-field="title" data-index="${i}" data-placeholder="Title">${esc(p.title)}</div>
        <div class="card-studio" contenteditable="true" data-field="studio" data-index="${i}" data-placeholder="Studio">${p.studio ? esc(p.studio) : ''}</div>
        <div class="card-role" contenteditable="true" data-field="role" data-index="${i}" data-placeholder="Role">${esc(p.role)}</div>
      </div>
    `;

    // Drag events
    card.addEventListener('dragstart', onDragStart);
    card.addEventListener('dragend', onDragEnd);
    card.addEventListener('dragover', onDragOver);
    card.addEventListener('drop', onDrop);
    card.addEventListener('dragenter', (e) => { e.preventDefault(); card.classList.add('drag-over'); });
    card.addEventListener('dragleave', () => card.classList.remove('drag-over'));

    // Double-click thumbnail to open editor
    card.querySelector('.card-thumb-wrap').addEventListener('dblclick', (e) => {
      e.stopPropagation();
      openProjectEditor(i);
    });

    // Edit/Delete clicks
    card.querySelector('.edit-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      openProjectEditor(i);
    });
    card.querySelector('.delete-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      deleteProject(i);
    });

    // Inline caption editing
    card.querySelectorAll('[contenteditable]').forEach(el => {
      // Prevent drag when editing text
      el.addEventListener('mousedown', (e) => { card.draggable = false; });
      el.addEventListener('blur', (e) => {
        card.draggable = true;
        const field = el.dataset.field;
        const idx = parseInt(el.dataset.index);
        const p = projects[idx];
        let val = el.textContent.trim();

        if (p[field] !== val) {
          p[field] = val;
          p._edited = true;
          markChanged();
        }
      });
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); el.blur(); }
        if (e.key === 'Escape') { el.blur(); }
      });
    });

    grid.appendChild(card);
  });

  // Add card
  const addCard = document.createElement('div');
  addCard.className = 'add-card';
  addCard.textContent = '+ Add Project';
  addCard.addEventListener('click', () => openEditModal(-1));
  grid.appendChild(addCard);
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// ---- Drag & Drop ----
let dragIndex = -1;

function onDragStart(e) {
  dragIndex = parseInt(e.currentTarget.dataset.index);
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function onDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  document.querySelectorAll('.admin-card').forEach(c => c.classList.remove('drag-over'));
}

function onDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

function onDrop(e) {
  e.preventDefault();
  const dropIndex = parseInt(e.currentTarget.dataset.index);
  e.currentTarget.classList.remove('drag-over');
  if (dragIndex === dropIndex) return;

  const moved = projects.splice(dragIndex, 1)[0];
  projects.splice(dropIndex, 0, moved);
  markChanged();
  renderGrid();
}

// ---- Edit Modal ----
function openEditModal(index) {
  editingIndex = index;
  newThumbFile = null;
  const modal = document.getElementById('editModal');
  const p = index >= 0 ? projects[index] : {
    title: '', studio: '', role: '', slug: '', videoUrls: [''], pageType: 'single', credit: '', description: ''
  };

  document.getElementById('modalTitle').textContent = index >= 0 ? 'Edit Project' : 'Add Project';
  document.getElementById('editTitle').value = p.title || '';
  document.getElementById('editStudio').value = p.studio || '';
  document.getElementById('editRole').value = p.role || '';
  document.getElementById('editSlug').value = p.slug || '';
  document.getElementById('editSlug').disabled = index >= 0;
  document.getElementById('editPageType').value = p.pageType || 'single';
  document.getElementById('editCredit').value = p.credit || '';
  document.getElementById('editDocDesc').value = p.description || '';
  document.getElementById('thumbUpload').value = '';

  const thumbSrc = p.thumbnail ? (p.thumbnail.startsWith('http') ? p.thumbnail : `/${p.thumbnail}`) : '';
  document.getElementById('thumbPreview').src = thumbSrc;

  // Show/hide doc description
  toggleDocDesc();

  // Video URLs
  renderVideoUrls(p.videoUrls || ['']);

  modal.classList.add('active');
}

document.getElementById('editPageType').addEventListener('change', toggleDocDesc);
function toggleDocDesc() {
  document.getElementById('docDescGroup').style.display =
    document.getElementById('editPageType').value === 'documentary' ? 'block' : 'none';
}

function renderVideoUrls(urls) {
  const container = document.getElementById('videoUrlList');
  container.innerHTML = '';
  urls.forEach((url, i) => {
    const div = document.createElement('div');
    div.className = 'video-url-group';
    div.innerHTML = `
      <input type="text" value="${esc(url)}" placeholder="https://www.youtube.com/embed/VIDEO_ID" data-vi="${i}">
      <button title="Remove" data-vi="${i}">&times;</button>
    `;
    div.querySelector('button').addEventListener('click', () => {
      const inputs = container.querySelectorAll('input');
      if (inputs.length <= 1) return;
      div.remove();
    });
    container.appendChild(div);
  });
}

document.getElementById('addVideoBtn').addEventListener('click', () => {
  const container = document.getElementById('videoUrlList');
  const div = document.createElement('div');
  div.className = 'video-url-group';
  div.innerHTML = `
    <input type="text" value="" placeholder="https://www.youtube.com/embed/VIDEO_ID">
    <button title="Remove">&times;</button>
  `;
  div.querySelector('button').addEventListener('click', () => {
    const inputs = container.querySelectorAll('input');
    if (inputs.length <= 1) return;
    div.remove();
  });
  container.appendChild(div);
});

document.getElementById('thumbUpload').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  newThumbFile = file;
  const reader = new FileReader();
  reader.onload = (ev) => {
    document.getElementById('thumbPreview').src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

document.getElementById('editCancel').addEventListener('click', () => {
  document.getElementById('editModal').classList.remove('active');
});

document.getElementById('editSave').addEventListener('click', async () => {
  const title = document.getElementById('editTitle').value.trim();
  const studio = document.getElementById('editStudio').value.trim();
  const role = document.getElementById('editRole').value.trim();
  const slug = document.getElementById('editSlug').value.trim().replace(/\s+/g, '-').toLowerCase();
  const pageType = document.getElementById('editPageType').value;
  const credit = document.getElementById('editCredit').value.trim();
  const description = document.getElementById('editDocDesc').value.trim();

  if (!title || !slug) {
    showToast('Title and slug are required');
    return;
  }

  // Collect video URLs
  const videoInputs = document.querySelectorAll('#videoUrlList input');
  const videoUrls = Array.from(videoInputs).map(i => i.value.trim()).filter(Boolean);

  // Handle thumbnail upload
  let thumbnail;
  let thumbPreview;
  if (newThumbFile) {
    try {
      const base64 = await compressImage(newThumbFile);
      const uploadResult = stageUpload(`${slug}.webp`, base64);
      stagedFiles.push(uploadResult.stagedFile);
      thumbnail = uploadResult.stagedFile.path;
      thumbPreview = 'data:image/webp;base64,' + base64;
    } catch (err) {
      showToast('Failed to process image: ' + err.message);
      return;
    }
  }

  // Auto-fetch thumbnail from first video if none uploaded
  if (!thumbnail && videoUrls.length > 0) {
    try {
      showToast('Fetching thumbnail from video...');
      const autoBase64 = await fetchVideoThumbnail(videoUrls[0]);
      if (autoBase64) {
        const uploadResult = stageUpload(`${slug}.webp`, autoBase64);
        stagedFiles.push(uploadResult.stagedFile);
        thumbnail = uploadResult.stagedFile.path;
        thumbPreview = 'data:image/webp;base64,' + autoBase64;
      }
    } catch (err) {
      console.warn('Auto-thumbnail failed:', err);
    }
  }

  if (editingIndex >= 0) {
    // Update existing
    const p = projects[editingIndex];
    p.title = title;
    p.studio = studio;
    p.role = role;
    p.pageType = pageType;
    p.credit = credit;
    p.description = description;
    p.videoUrls = videoUrls;
    if (thumbnail) {
      p.thumbnail = thumbnail;
      p._thumbPreview = thumbPreview;
    }
  } else {
    // Auto-fetch posters for each video in new projects
    const autoPosters = [];
    for (let i = 0; i < videoUrls.length; i++) {
      try {
        const posterBase64 = await fetchVideoThumbnail(videoUrls[i]);
        if (posterBase64) {
          const posterName = videoUrls.length > 1
            ? `${slug}-poster-${i + 1}.webp`
            : `${slug}-poster.webp`;
          const uploadResult = stageUpload(posterName, posterBase64);
          stagedFiles.push(uploadResult.stagedFile);
          autoPosters.push('../images/' + uploadResult.filename);
        } else {
          autoPosters.push('');
        }
      } catch (err) {
        console.warn('Auto-poster failed for video ' + (i + 1) + ':', err);
        autoPosters.push('');
      }
    }

    // Add new
    projects.push({
      slug,
      title,
      studio,
      role,
      pageType,
      credit: credit || role + '.',
      description,
      videoUrls,
      posters: autoPosters,
      thumbnail: thumbnail || `images/${slug}.webp`,
      hasLaurels: false,
      _thumbPreview: thumbPreview,
    });
  }

  markChanged();
  renderGrid();
  document.getElementById('editModal').classList.remove('active');
  showToast(editingIndex >= 0 ? 'Project updated' : 'Project added');
});

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Compress image client-side before uploading (avoids Vercel 4.5MB payload limit)
function compressImage(file, maxWidth = 1920, quality = 0.85) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      URL.revokeObjectURL(url);
      let w = img.naturalWidth;
      let h = img.naturalHeight;
      if (w > maxWidth) {
        h = Math.round(h * (maxWidth / w));
        w = maxWidth;
      }
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      // Try WebP first, fall back to JPEG
      let dataUrl = canvas.toDataURL('image/webp', quality);
      if (dataUrl.startsWith('data:image/webp')) {
        resolve(dataUrl.split(',')[1]);
      } else {
        dataUrl = canvas.toDataURL('image/jpeg', quality);
        resolve(dataUrl.split(',')[1]);
      }
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      reject(new Error('Failed to load image for compression'));
    };
    img.src = url;
  });
}

// Fetch thumbnail from video platform (Vimeo / YouTube)
async function fetchVideoThumbnail(videoUrl) {
  let thumbUrl = null;

  // YouTube: /embed/ID, youtu.be/ID, watch?v=ID
  const ytMatch = videoUrl.match(/(?:youtube\.com\/embed\/|youtu\.be\/|youtube\.com\/watch\?v=)([^?&/]+)/);
  if (ytMatch) {
    thumbUrl = `https://img.youtube.com/vi/${ytMatch[1]}/maxresdefault.jpg`;
  }

  // Vimeo: vimeo.com/ID, player.vimeo.com/video/ID
  const vimeoMatch = videoUrl.match(/(?:vimeo\.com\/|player\.vimeo\.com\/video\/)(\d+)/);
  if (vimeoMatch) {
    try {
      const res = await fetch(`https://vimeo.com/api/oembed.json?url=https://vimeo.com/${vimeoMatch[1]}`);
      const data = await res.json();
      thumbUrl = data.thumbnail_url;
      // Request higher resolution from Vimeo CDN
      if (thumbUrl) thumbUrl = thumbUrl.replace(/_\d+x\d+/, '_1920');
    } catch (e) {
      console.warn('Vimeo oEmbed failed:', e);
    }
  }

  if (!thumbUrl) return null;

  // Load image via canvas → base64
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      let w = img.naturalWidth, h = img.naturalHeight;
      if (w > 1920) { h = Math.round(h * (1920 / w)); w = 1920; }
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      let dataUrl = canvas.toDataURL('image/webp', 0.85);
      if (dataUrl.startsWith('data:image/webp')) {
        resolve(dataUrl.split(',')[1]);
      } else {
        resolve(canvas.toDataURL('image/jpeg', 0.85).split(',')[1]);
      }
    };
    img.onerror = () => resolve(null);
    img.src = thumbUrl;
  });
}

// Close modal on overlay click
document.getElementById('editModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) {
    e.currentTarget.classList.remove('active');
  }
});

// ---- Delete ----
function deleteProject(index) {
  const p = projects[index];
  if (!confirm(`Delete "${p.title}"? This will remove it on next publish.`)) return;
  deletedFiles.push(`projects/${p.slug}.html`);
  projects.splice(index, 1);
  markChanged();
  renderGrid();
  showToast('Project marked for deletion');
}

// ---- Changes tracking ----
let changeCount = 0;

function markChanged() {
  changeCount++;
  updatePublishBar();
}

function updatePublishBar() {
  const bar = document.getElementById('publishBar');
  const hasChanges = changeCount > 0 || stagedFiles.length > 0;
  bar.classList.toggle('active', hasChanges);
  document.getElementById('changeCount').textContent = changeCount + stagedFiles.length;
  document.getElementById('publishStatus').textContent = '';
}

document.getElementById('discardBtn').addEventListener('click', () => {
  if (!confirm('Discard all changes?')) return;
  projects = JSON.parse(JSON.stringify(originalProjects));
  stagedFiles = [];
  deletedFiles = [];
  changeCount = 0;
  renderGrid();
  updatePublishBar();
  showToast('Changes discarded');
});

// ---- Publish ----
document.getElementById('publishBtn').addEventListener('click', async () => {
  const btn = document.getElementById('publishBtn');
  const status = document.getElementById('publishStatus');
  btn.disabled = true;
  status.textContent = 'Publishing...';
  status.className = 'publish-status';

  try {
    // 1. Fetch current index.html and rebuild with current project order
    const indexHtml = await githubGet('index.html');
    const newIndexHtml = rebuildIndexHtml(indexHtml, projects);
    const allFiles = [{ path: 'index.html', content: newIndexHtml }];

    // 2. Add staged binary files (images/videos)
    allFiles.push(...stagedFiles);

    // 3. Regenerate project pages for edited projects
    for (const p of projects) {
      if (p._edited) {
        const pageData = {
          videoUrls: p.videoUrls || [''],
          posters: p.posters || [],
          credit: p.credit || (p.role || '') + '.',
          pageType: p.pageType || 'single',
          description: p.description || '',
          docPoster: p.docPoster || '',
          videoCaptions: p.videoCaptions || [],
          videoPreviews: p.videoPreviews || [],
          fourUpAfter: p.fourUpAfter || 0,
        };
        const pageHtml = generateProjectPage(p, pageData);
        const pageFile = { path: `projects/${p.slug}.html`, content: pageHtml };
        const existingIdx = allFiles.findIndex(f => f.path === pageFile.path);
        if (existingIdx >= 0) allFiles[existingIdx] = pageFile;
        else allFiles.push(pageFile);
      }
    }

    // 4. Commit directly to GitHub
    await commitToGitHub(allFiles, deletedFiles, `Update from admin panel \u2014 ${new Date().toLocaleString()}`);

    status.textContent = 'Published! Deploying...';
    status.className = 'publish-status success';

    // Reset state
    projects.forEach(p => delete p._edited);
    originalProjects = JSON.parse(JSON.stringify(projects));
    stagedFiles = [];
    deletedFiles = [];
    changeCount = 0;

    setTimeout(() => {
      updatePublishBar();
      showToast('Changes published — site will update in ~30 seconds');
    }, 2000);

  } catch (err) {
    status.textContent = 'Error: ' + err.message;
    status.className = 'publish-status error';
  } finally {
    btn.disabled = false;
  }
});

// ---- Toast ----
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// ---- Project Editor ----
let editorIndex = -1;
let editorVideoData = [];
let editorNewThumbFile = null;
let editorDocPosterFile = null;

function openProjectEditor(index) {
  editorIndex = index;
  editorNewThumbFile = null;
  editorDocPosterFile = null;
  const p = projects[index];

  dashboard.classList.remove('active');
  document.getElementById('projectEditor').classList.add('active');

  document.getElementById('editorProjectTitle').textContent = 'Edit: ' + p.title;
  document.getElementById('editorProjTitle').value = p.title || '';
  document.getElementById('editorProjStudio').value = p.studio || '';
  document.getElementById('editorProjRole').value = p.role || '';
  document.getElementById('editorCredits').innerHTML = p.credit || '';
  document.getElementById('editorPageType').value = p.pageType || 'single';
  document.getElementById('editorFourUpAfter').value = p.fourUpAfter || 0;
  document.getElementById('editorDocDesc').value = p.description || '';
  document.getElementById('editorThumbUpload').value = '';
  const thumbPrev = document.getElementById('editorThumbPreview');
  thumbPrev.src = p.thumbnail ? (p.thumbnail.startsWith('http') ? p.thumbnail : '/' + p.thumbnail) : '';
  toggleEditorDocFields();

  // Load existing preview video
  editorPreviewFile = null;
  editorPreviewCleared = false;
  const previewVid = document.getElementById('editorPreviewVideo');
  if (p.previewVideo) {
    previewVid.src = '/' + p.previewVideo;
  } else {
    previewVid.src = '';
  }
  document.getElementById('editorPreviewUpload').value = '';

  editorVideoData = (p.videoUrls && p.videoUrls.length ? p.videoUrls : ['']).map((url, i) => {
    const rawPoster = p.posters && p.posters[i] ? p.posters[i] : '';
    const rawPreview = p.videoPreviews && p.videoPreviews[i] ? p.videoPreviews[i] : '';
    return {
      url,
      caption: p.videoCaptions && p.videoCaptions[i] ? p.videoCaptions[i] : '',
      posterPath: rawPoster,
      posterFile: null,
      posterPreview: rawPoster ? rawPoster.replace(/^\.\.\//, '/') : '',
      previewPath: rawPreview,
      previewFile: null,
      previewCleared: false,
    };
  });
  renderEditorVideos();
}

function closeProjectEditor() {
  document.getElementById('projectEditor').classList.remove('active');
  dashboard.classList.add('active');
}

document.getElementById('editorBackBtn').addEventListener('click', closeProjectEditor);

// Rich text toolbar
document.getElementById('rteToolbar').addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  e.preventDefault();
  const cmd = btn.dataset.cmd;
  document.execCommand(cmd, false, null);
  document.getElementById('editorCredits').focus();
  updateRteToolbar();
});
document.getElementById('editorCredits').addEventListener('keyup', updateRteToolbar);
document.getElementById('editorCredits').addEventListener('mouseup', updateRteToolbar);
function updateRteToolbar() {
  document.querySelectorAll('#rteToolbar button[data-cmd]').forEach(btn => {
    const cmd = btn.dataset.cmd;
    if (cmd === 'removeFormat' || cmd === 'insertUnorderedList') return;
    btn.classList.toggle('active', document.queryCommandState(cmd));
  });
}

document.getElementById('editorPageType').addEventListener('change', toggleEditorDocFields);
function toggleEditorDocFields() {
  const val = document.getElementById('editorPageType').value;
  document.getElementById('editorDocFields').classList.toggle('active', val === 'documentary');
  document.getElementById('editorFourUpField').style.display = val === 'stacked' ? '' : 'none';
}

function renderEditorVideos() {
  const list = document.getElementById('editorVideoList');
  list.innerHTML = '';
  editorVideoData.forEach((v, i) => {
    const item = document.createElement('div');
    item.className = 'video-item';
    item.draggable = false;
    item.dataset.vi = i;
    const previewLabel = v.previewPath ? v.previewPath.split('/').pop() : '';
    item.innerHTML = `
      <span class="drag-handle" title="Drag to reorder">&#8942;&#8942;</span>
      <img class="video-poster-preview" src="${v.posterPreview || ''}" alt="" onerror="this.src=''">
      <div class="video-fields">
        <input type="text" value="${esc(v.url)}" placeholder="https://www.youtube.com/embed/VIDEO_ID" class="ev-url">
        <input type="text" value="${esc(v.caption || '')}" placeholder="Caption" class="ev-caption" style="margin-top:4px;">
        <label style="margin-top:6px; font-size:11px; color:var(--text-dim); display:block;">Poster Image</label>
        <input type="file" accept="image/*" class="ev-poster" title="Upload poster image (shown before play)">
        <label style="margin-top:6px; font-size:11px; color:var(--text-dim); display:block;">Preview Video</label>
        <div style="display:flex; align-items:center; gap:6px;">
          <input type="file" accept=".mp4,.webm" class="ev-video-preview" title="Upload preview video (auto-play loop)">
          <button type="button" class="ev-clear-preview btn" style="font-size:11px; padding:2px 8px;${v.previewPath && !v.previewCleared ? '' : ' display:none;'}" title="Remove preview video">Clear</button>
          <span class="ev-preview-label" style="font-size:11px; color:var(--text-dim);">${previewLabel}</span>
        </div>
      </div>
      <div class="video-actions">
        <button title="Remove">&times;</button>
      </div>
    `;
    // Only allow drag when grabbing the handle
    const handle = item.querySelector('.drag-handle');
    handle.addEventListener('mousedown', () => { item.draggable = true; });
    item.addEventListener('dragend', (e) => { item.draggable = false; onEditorVideoDragEnd(e); });
    item.addEventListener('dragstart', onEditorVideoDragStart);
    item.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
    item.addEventListener('drop', onEditorVideoDrop);
    item.addEventListener('dragenter', (e) => { e.preventDefault(); item.classList.add('drag-over'); });
    item.addEventListener('dragleave', () => item.classList.remove('drag-over'));

    item.querySelector('.ev-url').addEventListener('input', (e) => {
      editorVideoData[i].url = e.target.value;
    });
    item.querySelector('.ev-caption').addEventListener('input', (e) => {
      editorVideoData[i].caption = e.target.value;
    });
    item.querySelector('.ev-poster').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      editorVideoData[i].posterFile = file;
      const reader = new FileReader();
      reader.onload = (ev) => {
        editorVideoData[i].posterPreview = ev.target.result;
        item.querySelector('.video-poster-preview').src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });
    item.querySelector('.ev-video-preview').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      editorVideoData[i].previewFile = file;
      editorVideoData[i].previewCleared = false;
      const label = item.querySelector('.ev-preview-label');
      label.textContent = file.name;
      const clearBtn = item.querySelector('.ev-clear-preview');
      clearBtn.style.display = '';
    });
    item.querySelector('.ev-clear-preview').addEventListener('click', () => {
      editorVideoData[i].previewFile = null;
      editorVideoData[i].previewCleared = true;
      editorVideoData[i].previewPath = '';
      item.querySelector('.ev-video-preview').value = '';
      item.querySelector('.ev-preview-label').textContent = '';
      item.querySelector('.ev-clear-preview').style.display = 'none';
    });
    item.querySelector('.video-actions button').addEventListener('click', () => {
      if (editorVideoData.length <= 1) return;
      editorVideoData.splice(i, 1);
      renderEditorVideos();
    });
    list.appendChild(item);
  });
}

let editorDragIdx = -1;
function onEditorVideoDragStart(e) {
  editorDragIdx = parseInt(e.currentTarget.dataset.vi);
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}
function onEditorVideoDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  document.querySelectorAll('.video-item').forEach(v => v.classList.remove('drag-over'));
}
function onEditorVideoDrop(e) {
  e.preventDefault();
  const dropIdx = parseInt(e.currentTarget.dataset.vi);
  e.currentTarget.classList.remove('drag-over');
  if (editorDragIdx === dropIdx) return;
  const moved = editorVideoData.splice(editorDragIdx, 1)[0];
  editorVideoData.splice(dropIdx, 0, moved);
  renderEditorVideos();
}

document.getElementById('editorAddVideoBtn').addEventListener('click', () => {
  editorVideoData.push({ url: '', caption: '', posterPath: '', posterFile: null, posterPreview: '', previewPath: '', previewFile: null, previewCleared: false });
  renderEditorVideos();
});

document.getElementById('editorThumbUpload').addEventListener('change', (e) => {
  editorNewThumbFile = e.target.files[0] || null;
  if (editorNewThumbFile) {
    const reader = new FileReader();
    reader.onload = (ev) => {
      document.getElementById('editorThumbPreview').src = ev.target.result;
    };
    reader.readAsDataURL(editorNewThumbFile);
  }
});

// ---- Preview Video ----
let editorPreviewFile = null;
let editorPreviewCleared = false;

document.getElementById('editorPreviewUpload').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  editorPreviewFile = file;
  editorPreviewCleared = false;
  const vid = document.getElementById('editorPreviewVideo');
  vid.src = URL.createObjectURL(file);
});

document.getElementById('editorClearPreview').addEventListener('click', () => {
  editorPreviewFile = null;
  editorPreviewCleared = true;
  document.getElementById('editorPreviewVideo').src = '';
  document.getElementById('editorPreviewUpload').value = '';
});

document.getElementById('editorSaveBtn').addEventListener('click', async () => {
  const p = projects[editorIndex];
  const btn = document.getElementById('editorSaveBtn');
  btn.disabled = true;
  btn.textContent = 'Saving...';
  try {
    p.title = document.getElementById('editorProjTitle').value.trim();
    p.studio = document.getElementById('editorProjStudio').value.trim();
    p.role = document.getElementById('editorProjRole').value.trim();
    p.pageType = document.getElementById('editorPageType').value;
    p.fourUpAfter = parseInt(document.getElementById('editorFourUpAfter').value, 10) || 0;
    p.credit = document.getElementById('editorCredits').innerHTML.trim();
    p.description = document.getElementById('editorDocDesc').value.trim();
    p.videoUrls = editorVideoData.map(v => v.url).filter(Boolean);
    p.videoCaptions = editorVideoData.filter(v => v.url).map(v => v.caption || '');

    // Upload poster images
    const newPosters = [];
    for (let i = 0; i < editorVideoData.length; i++) {
      const v = editorVideoData[i];
      if (!v.url) continue;
      if (v.posterFile) {
        const base64 = await compressImage(v.posterFile);
        const posterName = p.videoUrls.length > 1
          ? `${p.slug}-poster-${i + 1}.webp`
          : `${p.slug}-poster.webp`;
        const uploadResult = stageUpload(posterName, base64);
        stagedFiles.push(uploadResult.stagedFile);
        newPosters.push('../images/' + uploadResult.filename);
      } else if (v.posterPath) {
        newPosters.push(v.posterPath);
      } else {
        // Auto-fetch poster from video source
        try {
          const autoBase64 = await fetchVideoThumbnail(v.url);
          if (autoBase64) {
            const posterName = p.videoUrls.length > 1
              ? `${p.slug}-poster-${i + 1}.webp`
              : `${p.slug}-poster.webp`;
            const uploadResult = stageUpload(posterName, autoBase64);
            stagedFiles.push(uploadResult.stagedFile);
            newPosters.push('../images/' + uploadResult.filename);
          } else {
            newPosters.push('');
          }
        } catch (err) {
          console.warn('Auto-poster failed for video ' + (i + 1) + ':', err);
          newPosters.push('');
        }
      }
    }
    p.posters = newPosters;

    // Upload per-video preview clips
    const newVideoPreviews = [];
    let videoIdx = 0;
    for (let i = 0; i < editorVideoData.length; i++) {
      const v = editorVideoData[i];
      if (!v.url) continue;
      if (v.previewFile) {
        const reader = new FileReader();
        const previewBase64 = await new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(v.previewFile);
        });
        const ext = v.previewFile.name.endsWith('.webm') ? '.webm' : '.mp4';
        const previewName = p.videoUrls.length > 1
          ? `${p.slug}-video-preview-${videoIdx + 1}${ext}`
          : `${p.slug}-video-preview${ext}`;
        const uploadResult = stageVideoUpload(previewName, previewBase64);
        stagedFiles.push(uploadResult.stagedFile);
        newVideoPreviews.push('../' + uploadResult.stagedFile.path);
      } else if (v.previewCleared) {
        newVideoPreviews.push('');
      } else if (v.previewPath) {
        newVideoPreviews.push(v.previewPath);
      } else {
        newVideoPreviews.push('');
      }
      videoIdx++;
    }
    p.videoPreviews = newVideoPreviews;

    // Upload thumbnail if changed
    if (editorNewThumbFile) {
      const base64 = await compressImage(editorNewThumbFile);
      const uploadResult = stageUpload(p.slug + '.webp', base64);
      stagedFiles.push(uploadResult.stagedFile);
      p.thumbnail = uploadResult.stagedFile.path;
      p._thumbPreview = 'data:image/webp;base64,' + base64;
    } else if (!p.thumbnail && p.videoUrls.length > 0) {
      try {
        showToast('Fetching thumbnail from video...');
        const autoBase64 = await fetchVideoThumbnail(p.videoUrls[0]);
        if (autoBase64) {
          const uploadResult = stageUpload(p.slug + '.webp', autoBase64);
          stagedFiles.push(uploadResult.stagedFile);
          p.thumbnail = uploadResult.stagedFile.path;
          p._thumbPreview = 'data:image/webp;base64,' + autoBase64;
        }
      } catch (err) {
        console.warn('Auto-thumbnail failed:', err);
      }
    }

    // Upload doc poster if changed
    if (editorDocPosterFile) {
      const base64 = await compressImage(editorDocPosterFile);
      const uploadResult = stageUpload(p.slug + '-doc-poster.webp', base64);
      stagedFiles.push(uploadResult.stagedFile);
      p.docPoster = '../images/' + uploadResult.filename;
    }

    // Upload preview video
    if (editorPreviewFile) {
      const reader = new FileReader();
      const videoBase64 = await new Promise((resolve, reject) => {
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(editorPreviewFile);
      });
      const ext = editorPreviewFile.name.endsWith('.webm') ? '.webm' : '.mp4';
      const uploadResult = stageVideoUpload(p.slug + '-preview' + ext, videoBase64);
      stagedFiles.push(uploadResult.stagedFile);
      p.previewVideo = uploadResult.stagedFile.path;
    } else if (editorPreviewCleared) {
      p.previewVideo = '';
    }

    p._edited = true;
    markChanged();
    renderGrid();
    closeProjectEditor();
    showToast('Project updated');
  } catch (err) {
    const msg = err && err.message ? err.message : String(err);
    console.error('Editor save error:', err);
    showToast('Error: ' + msg);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Save';
  }
});

// ---- Tab Navigation ----
const tabProjectsBtn = document.getElementById('tabProjects');
const tabAboutBtn = document.getElementById('tabAbout');
const projectGrid = document.getElementById('projectGrid');
const aboutEditorEl = document.getElementById('aboutEditor');
const publishBar = document.getElementById('publishBar');

tabProjectsBtn.addEventListener('click', () => {
  tabProjectsBtn.classList.add('active');
  tabAboutBtn.classList.remove('active');
  projectGrid.style.display = '';
  aboutEditorEl.classList.remove('active');
  publishBar.style.display = '';
});

tabAboutBtn.addEventListener('click', async () => {
  tabAboutBtn.classList.add('active');
  tabProjectsBtn.classList.remove('active');
  projectGrid.style.display = 'none';
  aboutEditorEl.classList.add('active');
  publishBar.style.display = 'none';
  await loadAboutData();
});

// ---- About Editor ----
let aboutData = null;
let aboutNewHeadshotFile = null;
let aboutNewPhotos = []; // { file, preview } for newly added photos

async function loadAboutData() {
  try {
    const aboutHtml = await githubGet('about.html');
    aboutData = parseAboutPage(aboutHtml);
    // Preserve logos HTML for page regeneration
    const logosMatch = aboutHtml.match(/(\s*<!-- Client logos -->[\s\S]*?<\/div>\s*<\/div>)/);
    aboutData._logosHtml = logosMatch ? logosMatch[1] : '';
    renderAboutEditor();
  } catch (err) {
    showToast('Failed to load about page: ' + err.message);
  }
}

function renderAboutEditor() {
  if (!aboutData) return;

  document.getElementById('aboutHeading').value = aboutData.heading || '';
  document.getElementById('aboutContact').value = aboutData.contactHtml || '';

  // Headshot
  const headshotPrev = document.getElementById('aboutHeadshotPreview');
  headshotPrev.src = aboutData.headshotSrc ? '/' + aboutData.headshotSrc : '';
  aboutNewHeadshotFile = null;
  document.getElementById('aboutHeadshotUpload').value = '';

  // Bio paragraphs
  renderAboutBio();

  // Photo grid
  aboutNewPhotos = [];
  renderAboutPhotos();
}

function renderAboutBio() {
  const list = document.getElementById('aboutBioList');
  list.innerHTML = '';
  (aboutData.bioParas || []).forEach((text, i) => {
    const div = document.createElement('div');
    div.className = 'about-bio-para';
    div.innerHTML = `
      <textarea>${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
      <button class="remove-para" title="Remove paragraph">&times;</button>
    `;
    div.querySelector('textarea').addEventListener('input', (e) => {
      aboutData.bioParas[i] = e.target.value;
    });
    div.querySelector('.remove-para').addEventListener('click', () => {
      aboutData.bioParas.splice(i, 1);
      renderAboutBio();
    });
    list.appendChild(div);
  });
}

document.getElementById('aboutAddParaBtn').addEventListener('click', () => {
  if (!aboutData) return;
  aboutData.bioParas.push('');
  renderAboutBio();
  // Focus the new textarea
  const textareas = document.querySelectorAll('#aboutBioList textarea');
  if (textareas.length) textareas[textareas.length - 1].focus();
});

function renderAboutPhotos() {
  const grid = document.getElementById('aboutPhotoGrid');
  grid.innerHTML = '';

  // Existing photos
  const allPhotos = aboutData.photos || [];
  allPhotos.forEach((src, i) => {
    const item = document.createElement('div');
    item.className = 'about-photo-item';
    item.innerHTML = `
      <img src="/${src}" alt="" onerror="this.style.background='#333'">
      <button class="photo-remove" title="Remove">&times;</button>
    `;
    item.querySelector('.photo-remove').addEventListener('click', () => {
      aboutData.photos.splice(i, 1);
      renderAboutPhotos();
    });
    grid.appendChild(item);
  });

  // Newly added photos (not yet uploaded)
  aboutNewPhotos.forEach((np, i) => {
    const item = document.createElement('div');
    item.className = 'about-photo-item';
    item.innerHTML = `
      <img src="${np.preview}" alt="">
      <button class="photo-remove" title="Remove">&times;</button>
    `;
    item.querySelector('.photo-remove').addEventListener('click', () => {
      aboutNewPhotos.splice(i, 1);
      renderAboutPhotos();
    });
    grid.appendChild(item);
  });
}

// Headshot upload
document.getElementById('aboutHeadshotUpload').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  aboutNewHeadshotFile = file;
  const reader = new FileReader();
  reader.onload = (ev) => {
    document.getElementById('aboutHeadshotPreview').src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

// Photo uploads (multiple)
document.getElementById('aboutPhotoUpload').addEventListener('change', (e) => {
  const files = Array.from(e.target.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      aboutNewPhotos.push({ file, preview: ev.target.result });
      renderAboutPhotos();
    };
    reader.readAsDataURL(file);
  });
  e.target.value = '';
});

// Save About
document.getElementById('aboutSaveBtn').addEventListener('click', async () => {
  if (!aboutData) return;
  const btn = document.getElementById('aboutSaveBtn');
  btn.disabled = true;
  btn.textContent = 'Saving...';

  try {
    const updates = {
      heading: document.getElementById('aboutHeading').value.trim(),
      bioParas: aboutData.bioParas,
      contactHtml: document.getElementById('aboutContact').value.trim(),
      headshotSrc: aboutData.headshotSrc,
      photos: [...aboutData.photos],
      _logosHtml: aboutData._logosHtml || '',
    };

    // Upload new headshot if changed
    if (aboutNewHeadshotFile) {
      const base64 = await compressImage(aboutNewHeadshotFile);
      const result = stageUpload('headshot.webp', base64);
      stagedFiles.push(result.stagedFile);
      updates.headshotSrc = result.stagedFile.path;
    }

    // Upload new grid photos
    for (let i = 0; i < aboutNewPhotos.length; i++) {
      const np = aboutNewPhotos[i];
      const base64 = await compressImage(np.file);
      const safeName = 'about-' + Date.now() + '-' + i + '.webp';
      const result = stageUpload(safeName, base64);
      stagedFiles.push(result.stagedFile);
      updates.photos.push(result.stagedFile.path);
    }

    // Generate about page HTML client-side
    const newAboutHtml = generateAboutPage(updates);
    stagedFiles.push({ path: 'about.html', content: newAboutHtml });

    aboutNewPhotos = [];
    aboutNewHeadshotFile = null;
    markChanged();
    showToast('About page saved — publish to deploy');

    // Switch back to Projects tab so they can see the publish bar
    tabProjectsBtn.click();

  } catch (err) {
    showToast('Error: ' + (err.message || err));
  } finally {
    btn.disabled = false;
    btn.textContent = 'Save About Page';
  }
});

// ---- Keyboard shortcuts ----
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.getElementById('editModal').classList.remove('active');
    if (document.getElementById('projectEditor').classList.contains('active')) {
      closeProjectEditor();
    }
  }
});
</script>
</body>
</html>
